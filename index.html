<!DOCTYPE html>
<!-- 所有 UI 设计必须符合 Apple 审美，做到 Only Apple can do 的效果。 -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>作业进度</title>
    <style>
        :root {
            --toolbar-control-size: 40px;
            --floating-hub-gap: min(24px, 5vw);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 40px 20px 40px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: min(1080px, 96vw);
            margin: 0 auto;
            display: grid;
            gap: clamp(32px, 6vh, 48px);
        }

        #subjectsContainer {
            width: 100%;
            max-width: min(980px, 100%);
            margin: 0 auto;
            display: grid;
            gap: clamp(24px, 4vh, 32px);
        }

        .command-hub {
            position: sticky;
            top: clamp(12px, 4vh, 28px);
            z-index: 2200;
            display: grid;
            gap: clamp(14px, 3vh, 20px);
            padding: clamp(18px, 4vh, 26px) clamp(24px, 5vw, 32px);
            margin: 0 auto clamp(16px, 4vh, 28px);
            border-radius: 28px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.94), rgba(232, 240, 255, 0.7));
            border: 1px solid rgba(202, 212, 255, 0.45);
            box-shadow: 0 24px 60px rgba(37, 99, 235, 0.16);
            backdrop-filter: blur(24px) saturate(170%);
            -webkit-backdrop-filter: blur(24px) saturate(170%);
            transition: padding 0.24s ease, box-shadow 0.24s ease, border-color 0.24s ease, background 0.24s ease, max-height 0.3s ease;
            width: min(1040px, 96vw);
            max-width: min(1040px, 96vw);
        }

        .command-hub.hub-expanded {
            display: grid;
        }

        .command-hub.compact {
            padding: clamp(16px, 3vh, 20px) clamp(20px, 4vw, 26px);
            box-shadow: 0 20px 40px rgba(15, 23, 42, 0.16);
            border-color: rgba(99, 102, 241, 0.32);
            background: rgba(255, 255, 255, 0.92);
        }

        .command-hub.floating-mode {
            justify-self: flex-start;
            margin-left: clamp(12px, 5vw, 28px);
            margin-right: auto;
            transition: width 0.26s ease, padding 0.26s ease, margin 0.26s ease, box-shadow 0.26s ease, transform 0.24s ease;
        }

        .command-hub.hub-collapsed {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0;
            padding: 0;
            width: 56px;
            height: 56px;
            max-width: none;
            min-width: 0;
            background: transparent;
            border: none;
            box-shadow: none;
            backdrop-filter: none;
            -webkit-backdrop-filter: none;
            cursor: pointer;
        }

        .command-hub.floating-mode.hub-collapsed {
            position: fixed;
            top: var(--floating-hub-gap);
            left: var(--floating-hub-gap);
            margin: 0;
            max-width: calc(100vw - (var(--floating-hub-gap) * 2));
        }

        .command-hub.hub-collapsed .command-toolbar {
            display: none !important;
        }

        .command-hub.hub-collapsed .command-subtitle-inline,
        .command-hub.hub-collapsed .command-actions,
        .command-hub.hub-collapsed .command-utility,
        .command-hub.hub-collapsed .progress-section,
        .command-hub.hub-collapsed .divider,
        .command-hub.hub-collapsed .command-title,
        .command-hub.hub-collapsed h1 {
            display: none !important;
        }

        .command-hub .hub-collapse-icon {
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 6px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.96), rgba(232, 240, 255, 0.72));
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.55), 0 18px 36px rgba(37, 99, 235, 0.24);
            backdrop-filter: blur(22px) saturate(180%);
            -webkit-backdrop-filter: blur(22px) saturate(180%);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
        }

        .command-hub .hub-collapse-icon span {
            display: block;
            width: 24px;
            height: 2.8px;
            border-radius: 999px;
            background: rgba(17, 24, 39, 0.82);
            transition: background 0.2s ease, width 0.2s ease;
        }

        .command-hub .hub-collapse-icon span:nth-child(2) {
            width: 28px;
        }

        .command-hub .hub-collapse-icon span:nth-child(1),
        .command-hub .hub-collapse-icon span:nth-child(3) {
            width: 20px;
        }

        .command-hub.hub-collapsed .hub-collapse-icon {
            display: inline-flex;
        }

        .command-hub.hub-collapsed:hover .hub-collapse-icon {
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 24px 44px rgba(37, 99, 235, 0.3);
            transform: translateY(-1px);
        }

        .command-hub.hub-collapsed:hover .hub-collapse-icon span {
            background: rgba(17, 24, 39, 0.92);
        }

        .command-hub.hub-collapsed:focus-visible .hub-collapse-icon {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.45), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .command-hub.floating-mode.hub-expanded {
            width: min(1040px, 96vw);
            max-width: min(1040px, 96vw);
            cursor: auto;
        }

        .command-hub.hub-expanded .command-actions {
            display: flex;
        }

        .command-hub.hub-expanded .command-subtitle-inline {
            display: inline;
        }

        .command-hub .progress-header[aria-disabled="true"] {
            cursor: default;
        }

        .command-hub .progress-header[aria-disabled="true"]:hover {
            background: transparent;
        }

        h1 {
            color: #1d1d1f;
            font-size: 2.2rem;
            line-height: 1.1;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin: 0;
        }

        .command-toolbar {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 24px;
            flex-wrap: wrap;
        }

        .command-title {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            min-width: 360px;
            flex: 1 1 360px;
        }

        .command-subtitle-inline {
            font-size: 0.95em;
            color: #6e6e73;
            letter-spacing: -0.01em;
            white-space: normal;
            line-height: 1.45;
            max-width: 48ch;
        }

        .command-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 2 1 480px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .command-utility {
            display: flex;
            gap: 12px;
            flex-wrap: nowrap;
            justify-content: flex-end;
        }

        @media (max-width: 768px) {
            .command-hub {
                top: 16px;
                max-width: 100%;
                padding: 18px 18px 20px;
                gap: 14px;
                margin-bottom: 24px;
            }

            .command-toolbar {
                flex-direction: column;
                align-items: flex-start;
                gap: 14px;
            }

            .command-title {
                min-width: 0;
                flex: 1 1 100%;
            }

            .command-actions {
                width: 100%;
                flex: 1 1 100%;
                justify-content: flex-start;
                align-items: flex-start;
            }
        }

        /* Narrow screen layout adjustments */
        @media (max-width: 600px) {
            body {
                display: block;
                padding: 28px 14px 36px;
            }

            .container {
                max-width: 100%;
                gap: 24px;
            }

            #subjectsContainer {
                max-width: 100%;
                gap: 20px;
            }

            .command-hub {
                position: static;
                width: 100%;
                max-width: 100%;
                padding: 18px 16px 20px;
                margin: 0 auto 20px;
                border-radius: 22px;
                gap: 12px;
                box-shadow: 0 18px 42px rgba(37, 99, 235, 0.14);
            }

            .command-toolbar {
                gap: 12px;
            }

            .command-actions {
                width: 100%;
            }

            .command-utility {
                width: 100%;
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }

            .command-utility .toolbar {
                width: 100%;
                justify-content: flex-start;
                flex-wrap: nowrap;
                padding: 6px;
                gap: 6px;
                overflow-x: auto;
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .command-utility .toolbar::-webkit-scrollbar {
                display: none;
            }

            .filter-control {
                height: auto;
            }

            .filter-toggle {
                width: 38px;
                height: 38px;
            }

            .toolbar-btn {
                flex: 0 0 auto;
                height: 38px;
                min-height: 38px;
                padding: 0 16px;
                font-size: 0.85em;
                width: auto;
            }

            .filter-popover {
                top: calc(100% + 12px);
                right: auto;
                left: 0;
                width: min(260px, calc(100vw - 32px));
                padding: 16px 16px 14px;
            }

            .filter-chip-row {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }

            .progress-section {
                padding: 14px 14px 16px;
            }

            .progress-header {
                flex-wrap: wrap;
                gap: 10px;
                align-items: flex-start;
            }

            .progress-title {
                font-size: 0.95em;
                gap: 8px;
                white-space: normal;
            }

            #progressText {
                margin-top: 2px;
            }

            .progress-section.collapsed .progress-inline {
                width: 100%;
            }

            .stats {
                padding-bottom: 2px;
                gap: 12px;
            }

            .stat-item {
                min-width: 160px;
            }

            .subject-section {
                padding: 20px 16px;
                border-radius: 22px;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 16px;
            }

            .hover-controls {
                gap: 12px;
            }

            .pages-controls {
                flex-wrap: wrap;
                gap: 8px;
                justify-content: space-between;
            }

            .pages-controls .mini-input {
                flex: 1 1 calc(50% - 8px);
                min-width: 100px;
                width: auto;
            }

            .pages-controls .slash {
                display: none;
            }

            .modal-content {
                width: calc(100% - 32px);
                padding: 20px 18px;
            }

            #helpModal .help-content {
                max-height: 56vh;
            }

            .theme-popover {
                min-width: auto;
                width: calc(100vw - 32px);
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.85rem;
            }

            .command-subtitle-inline {
                font-size: 0.9em;
            }

            .toolbar-btn {
                padding: 0 14px;
                width: auto;
            }

            .filter-chip-row {
                grid-template-columns: 1fr;
            }

            .stat-item {
                min-width: 140px;
            }
        }

        .filter-control {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
            height: var(--toolbar-control-size, 40px);
            align-self: center;
            vertical-align: middle;
        }

        .filter-toggle {
            width: var(--toolbar-control-size, 40px);
            height: var(--toolbar-control-size, 40px);
            border: none;
            border-radius: calc(var(--toolbar-control-size, 40px) / 2);
            background: rgba(255, 255, 255, 0.82);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(60, 60, 67, 0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            flex-shrink: 0;
        }

        .filter-toggle:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 18px rgba(0, 0, 0, 0.12);
        }

        .filter-toggle:active {
            transform: scale(0.96);
        }

        .filter-toggle svg {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #1c1c1e;
            stroke-width: 1.6px;
        }

        .filter-toggle.active {
            background: rgba(0, 122, 255, 0.12);
            border-color: rgba(0, 122, 255, 0.35);
            box-shadow: 0 10px 22px rgba(10, 132, 255, 0.2);
        }

        .filter-toggle.active svg {
            stroke: #0a84ff;
        }

        .filter-popover {
            position: absolute;
            top: calc(var(--toolbar-control-size, 40px) + 12px);
            right: -4px;
            width: 280px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 14px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(60, 60, 67, 0.12);
            padding: 18px 18px 16px;
            display: none;
            flex-direction: column;
            gap: 16px;
            backdrop-filter: saturate(180%) blur(22px);
            -webkit-backdrop-filter: saturate(180%) blur(22px);
            z-index: 2100;
            animation: filter-popover-in 0.18s ease;
        }

        .filter-popover.open {
            display: flex;
        }

        @keyframes filter-popover-in {
            from {
                opacity: 0;
                transform: translateY(6px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-section-title {
            font-size: 0.75em;
            font-weight: 600;
            color: rgba(28, 28, 30, 0.7);
            letter-spacing: -0.01em;
        }

        .filter-chip-row {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 8px;
            width: 100%;
        }

        .filter-chip {
            position: relative;
            padding: 6px 18px;
            border-radius: 999px;
            font-size: 0.85em;
            font-weight: 500;
            border: 1px solid rgba(60, 60, 67, 0.1);
            background: rgba(118, 118, 128, 0.12);
            color: #1c1c1e;
            cursor: pointer;
            transition: all 0.18s ease;
            display: inline-flex;
            width: 100%;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            text-align: center;
        }

        .filter-chip[data-status="completed"] {
            background: rgba(52, 199, 89, 0.16);
            border-color: rgba(52, 199, 89, 0.4);
            color: #1f8a4d;
        }

        .filter-chip[data-status="in-progress"] {
            background: rgba(255, 159, 10, 0.18);
            border-color: rgba(255, 159, 10, 0.42);
            color: #b25b06;
        }

        .filter-chip[data-status="not-started"] {
            background: rgba(255, 69, 58, 0.18);
            border-color: rgba(255, 69, 58, 0.42);
            color: #b81c34;
        }

        .filter-chip:hover {
            filter: saturate(1.1) brightness(1.05);
        }

        .filter-chip.active {
            background: rgba(118, 118, 128, 0.24);
            border-color: rgba(118, 118, 128, 0.4);
            color: #3a3a3c;
        }


        .filter-reset {
            align-self: flex-end;
            font-size: 0.8em;
            font-weight: 500;
            color: #3a3a3c;
            background: transparent;
            border: none;
            padding: 0;
            margin-top: -4px;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .filter-reset:hover {
            opacity: 0.7;
        }

        .filter-empty-state {
            font-size: 0.9em;
            color: #6e6e73;
            text-align: center;
            padding: 16px 0 4px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: #007aff;
            color: white;
        }

        .btn:hover {
            background: #0051d5;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #86868b;
        }

        .btn-secondary:hover {
            background: #6e6e73;
        }

        .subject-section {
            background: linear-gradient(140deg, rgba(255, 255, 255, 0.92), rgba(244, 247, 255, 0.82));
            padding: 26px 28px;
            border-radius: 26px;
            border: 1px solid rgba(202, 212, 255, 0.36);
            box-shadow: 0 14px 36px rgba(15, 23, 42, 0.08);
            margin: 0 auto 24px;
            width: min(100%, 960px);
            position: relative;
            transition: box-shadow .24s cubic-bezier(0.4, 0, 0.2, 1), transform .24s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
            backdrop-filter: blur(18px) saturate(150%);
            -webkit-backdrop-filter: blur(18px) saturate(150%);
        }
        .subject-section:hover { transform: translateY(-2px); box-shadow: 0 18px 40px rgba(15,23,42,0.12); }

        .subject-section.draggable-subject {
            cursor: move;
        }

        .subject-section.dragging-subject {
            opacity: 0.5;
        }

        .subject-section.drag-over-subject {
            border: 2px dashed #007aff;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .subject-title {
            color: #1d1d1f;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .subject-actions {
            display: none;
            gap: 8px;
        }

        .subject-section.edit-mode .subject-actions {
            display: flex;
        }

        .icon-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            background: #f5f5f7;
            color: #1d1d1f;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #e5e5e7;
        }

        .icon-btn.delete {
            background: #ff3b30;
            color: white;
        }

        .icon-btn.delete:hover {
            background: #d32f2f;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 16px;
        }

        .card {
            padding: 18px 20px;
            border-radius: 20px;
            color: #111827;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                        border-color 0.3s ease,
                        opacity 0.2s ease;
            box-shadow: 0 6px 14px rgba(15, 23, 42, 0.08);
            position: relative;
            border: 1px solid transparent;
        }

        @keyframes card-pulse {
            0% { transform: scale(1) translateY(0); }
            50% { transform: scale(0.98) translateY(-2px); }
            100% { transform: scale(1) translateY(0); }
        }

        .card.status-changing {
            animation: card-pulse 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.draggable {
            cursor: move;
        }

        .card.dragging {
            opacity: 0.5;
        }

        .card.drag-over {
            border: 2px dashed rgba(17, 24, 39, 0.25);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.12);
        }

        .card.completed {
            background: linear-gradient(150deg, rgba(34, 197, 94, 0.9), rgba(4, 120, 87, 0.92));
            border-color: rgba(5, 150, 105, 0.6);
            color: #ecfdf3;
        }

        .card.in-progress {
            background: linear-gradient(150deg, rgba(249, 115, 22, 0.9), rgba(202, 138, 4, 0.92));
            border-color: rgba(234, 88, 12, 0.6);
            color: #fff7ed;
        }

        .card.not-started {
            background: linear-gradient(150deg, rgba(239, 68, 68, 0.92), rgba(220, 38, 38, 0.94));
            border-color: rgba(220, 38, 38, 0.65);
            color: #fef2f2;
        }

        .card.add-card {
            background: rgba(255, 255, 255, 0.7);
            color: #0a84ff;
            display: none;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            border: 1px dashed rgba(10, 132, 255, 0.4);
        }

        .edit-mode .card.add-card {
            display: flex;
        }

        .card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }

        .edit-mode .card-delete {
            display: flex;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .card-status {
            font-size: 0.9em;
            opacity: 0.72;
            font-weight: 500;
            color: inherit;
            letter-spacing: -0.01em;
        }

        /* progress controls */
        .hover-controls {
            margin-top: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            pointer-events: none;
            transform: translateY(-6px);
            transition: opacity 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        transform 0.25s cubic-bezier(0.4, 0, 0.2, 1),
                        margin-top 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover .hover-controls,
        .card:focus-within .hover-controls,
        .subject-section.edit-mode .hover-controls {
            opacity: 1;
            max-height: 160px;
            pointer-events: auto;
            transform: translateY(0);
            margin-top: 12px;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card:hover .hover-controls > *,
        .card:focus-within .hover-controls > *,
        .subject-section.edit-mode .hover-controls > * {
            animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) backwards;
        }
        .pages-controls { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 14px; background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(255, 255, 255, 0.5); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); }
        .pages-controls .mini-input { transition: background-color .18s ease, transform .18s ease; }
        .pages-controls .mini-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(10,132,255,0.25); }
        .pages-controls .mini-input:active { transform: scale(0.99); }
        .mini-input { width: 72px; height: 30px; border-radius: 10px; border: 1px solid rgba(17, 24, 39, 0.08); padding: 4px 8px; background: rgba(255, 255, 255, 0.92); color: #1d1d1f; }
        .page-input { width: 80px; }
        .pages-controls .slash { opacity: 0.78; }
        [data-theme="dark"] .mini-input { background: rgba(28,28,30,0.92); color: #f5f5f7; border-color: rgba(255,255,255,0.12); }
        .sub-title { margin-top: 16px; font-size: 0.95em; color: #6e6e73; font-weight: 600; }
        [data-theme="dark"] .sub-title { color: #a1a1a6; }


        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 4200;
            align-items: center;
            justify-content: center;
            display: flex;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity .24s cubic-bezier(0.4,0,0.2,1), visibility 0s linear .24s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity .24s cubic-bezier(0.4,0,0.2,1);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(8px) scale(0.995);
            opacity: 0;
            transition: transform .28s cubic-bezier(0.22,0.61,0.36,1), opacity .2s ease;
        }
        .modal.active .modal-content { transform: none; opacity: 1; }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #007aff;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .progress-section {
            background: rgba(255, 255, 255, 0.75);
            border-radius: 22px;
            border: 1px solid rgba(202, 212, 255, 0.4);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
            display: grid;
            gap: 14px;
            padding: 16px 18px 18px;
            transition: background 0.24s ease, border-color 0.24s ease, box-shadow 0.24s ease, padding 0.24s ease;
        }

        .progress-section.collapsed {
            padding: 12px 16px 12px;
            gap: 8px;
            background: rgba(255, 255, 255, 0.68);
            border-color: rgba(202, 212, 255, 0.3);
        }

        .command-hub.compact .progress-section {
            background: rgba(255, 255, 255, 0.88);
        }

        .progress-header {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 6px 10px;
            border-radius: 18px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s ease;
        }

        .progress-header:focus-visible {
            outline: 2px solid rgba(37, 99, 235, 0.6);
            outline-offset: 4px;
        }

        .progress-header:hover {
            background: rgba(37, 99, 235, 0.12);
        }

        .progress-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1em;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.01em;
            white-space: nowrap;
        }

        #progressText {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(37, 99, 235, 0.14);
            color: #1d4ed8;
            font-size: 0.88em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .toggle-icon {
            width: 32px;
            height: 32px;
            border-radius: 12px;
            background: rgba(37, 99, 235, 0.08);
            color: #4b5563;
            font-size: 1.15em;
            display: grid;
            place-items: center;
            margin-left: auto;
            transition: transform 0.3s ease, background 0.2s ease, color 0.2s ease;
        }

        .progress-header:hover .toggle-icon {
            background: rgba(37, 99, 235, 0.16);
            color: #1d4ed8;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .progress-inline {
            display: none;
            flex: 1;
            align-items: center;
            gap: 12px;
        }

        .progress-inline-track {
            width: 100%;
            height: 6px;
            background: rgba(37, 99, 235, 0.14);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-inline-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(118deg, #2563eb, #38bdf8);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-inline-bar.complete {
            background: linear-gradient(118deg, #34c759, #22c55e);
        }

        .progress-inline-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: translateX(-100%);
        }

        .progress-inline-bar.animating::after {
            animation: progress-shimmer 1s ease;
        }

        .progress-section.collapsed .progress-inline {
            display: flex;
        }

        .progress-content {
            max-height: 520px;
            overflow: hidden;
            display: grid;
            gap: 16px;
            padding: 0 4px 4px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.24s ease;
        }

        .progress-content.collapsed {
            max-height: 0;
            padding: 0;
            opacity: 0;
            pointer-events: none;
        }

        .progress-meter {
            display: grid;
            gap: 8px;
        }

        .progress-summary {
            font-size: 0.9em;
            color: #636366;
            letter-spacing: -0.01em;
            padding: 0 4px;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(37, 99, 235, 0.16);
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(118deg, #2563eb, #38bdf8);
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1),
                        background 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: translateX(-100%);
        }

        .progress-bar.animating::after {
            animation: progress-shimmer 1s ease;
        }

        @keyframes progress-shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Subject mini progress */
        .subject-progress { display:flex; align-items:center; gap:10px; margin: -4px 0 12px; }
        .subject-progress .progress-bar-container { flex: 1; height: 6px; background: rgba(60, 60, 67, 0.14); }
        .subject-progress-text { font-size: 0.95em; font-weight: 600; color: #1d1d1f; min-width: 44px; text-align: right; letter-spacing: -0.01em; }
        [data-theme='dark'] .subject-progress-text { color: #f5f5f7; }
        /* when any progress bar completes */
        .progress-bar.complete { background: #34c759; }
        [data-theme='dark'] .progress-bar.complete { background: #30d158; }

        .stats {
            display: flex;
            gap: clamp(10px, 2vw, 16px);
            margin-top: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .stats::-webkit-scrollbar {
            height: 6px;
        }

        .stats::-webkit-scrollbar-thumb {
            background: rgba(37, 99, 235, 0.3);
            border-radius: 999px;
        }

        .stat-item {
            flex: 1 1 0;
            min-width: 140px;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.62);
            border-radius: 16px;
            border: 1px solid rgba(202, 212, 255, 0.32);
            text-align: left;
            display: grid;
            gap: 6px;
        }

        .stat-number {
            font-size: 1.6em;
            font-weight: 600;
            color: #111827;
            letter-spacing: -0.02em;
        }

        .stat-label {
            color: #6e6e73;
            font-size: 0.82em;
            font-weight: 500;
        }

        .float-btn {
            position: fixed;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            padding: 12px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            color: #1f1f21;
            border: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.01em;
        }

        .float-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .float-btn:active {
            transform: translateY(-50%) scale(0.98);
        }

        .float-btn-icon {
            font-size: 1.2em;
        }

        .help-btn {
            position: fixed;
            left: 30px;
            top: 30px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            color: #1f1f21;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .help-btn:active {
            transform: scale(0.95);
        }

        .help-content {
            line-height: 1.6;
        }

        .help-content h3 {
            color: #1d1d1f;
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .help-content h3:first-child {
            margin-top: 0;
        }

        .help-content p {
            color: #6e6e73;
            margin-bottom: 8px;
        }

        .help-content ul {
            list-style: none;
            padding-left: 0;
        }

        .help-content li {
            color: #6e6e73;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .help-content li:before {
            content: "•";
            position: absolute;
            left: 6px;
            color: #007aff;
        }

        @media (max-width: 768px) {
            .btn {
                flex: 1;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .float-btn {
                right: 20px;
                padding: 10px 16px;
                font-size: 0.85em;
            }

            .float-btn-icon {
                font-size: 1em;
            }

            .help-btn {
                left: 20px;
                top: 20px;
                width: 32px;
                height: 32px;
                font-size: 1em;
            }
        }

        .footer {
            text-align: center;
            color: #86868b;
            font-size: 0.85em;
            font-weight: 400;
            letter-spacing: -0.01em;
            margin: 60px 0 40px;
            padding: 0 20px;
        }

        .footer-divider {
            margin: 0 8px;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .footer {
                font-size: 0.8em;
                margin: 40px 0 30px;
            }
        }

        /* 主题：基础与暗色覆盖 */
        :root { color-scheme: light; }
        [data-theme='dark'] { color-scheme: dark; }

        /* 右上角胶囊按钮（Apple 风格） */
        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            background: #f5f5f7;
            color: #1d1d1f;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            flex: 0 0 auto;
        }
        .tool-btn:hover { background: #e5e5e7; transform: translateY(-1px); }

        /* 暗色覆盖（贴近 Apple 系统色板） */
        [data-theme='dark'] body { background: #000000; color: #f5f5f7; }
        [data-theme='dark'] h1,
        [data-theme='dark'] .subject-title,
        [data-theme='dark'] .modal-title,
        [data-theme='dark'] .form-label,
        [data-theme='dark'] .progress-title,
        [data-theme='dark'] .stat-number { color: #f5f5f7; }

        [data-theme='dark'] .command-hub { background: rgba(17, 24, 39, 0.85); border-color: rgba(129, 140, 248, 0.38); box-shadow: 0 24px 60px rgba(0, 0, 0, 0.58); }
        [data-theme='dark'] .command-hub.compact { background: rgba(17, 24, 39, 0.9); border-color: rgba(129, 140, 248, 0.45); }
        [data-theme='dark'] .command-hub.hub-collapsed h1 { color: #f5f5f7; }
        [data-theme='dark'] .command-hub .hub-collapse-icon {
            background: linear-gradient(155deg, rgba(40, 51, 92, 0.92), rgba(16, 21, 37, 0.92));
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 20px 40px rgba(0, 0, 0, 0.7);
        }
        [data-theme='dark'] .command-hub .hub-collapse-icon span {
            background: rgba(248, 250, 252, 0.88);
        }
        [data-theme='dark'] .command-hub.hub-collapsed:hover .hub-collapse-icon {
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.12), 0 24px 48px rgba(15, 23, 42, 0.72);
        }
        [data-theme='dark'] .command-hub.hub-collapsed:focus-visible .hub-collapse-icon {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.55), inset 0 1px 0 rgba(255, 255, 255, 0.14);
        }
        [data-theme='dark'] .command-hub.hub-collapsed:hover .hub-collapse-icon span {
            background: rgba(248, 250, 252, 0.95);
        }
        [data-theme='dark'] .command-subtitle-inline { color: rgba(235, 235, 245, 0.6); }
        [data-theme='dark'] .command-subtitle-inline { color: rgba(235, 235, 245, 0.6); }

        [data-theme='dark'] .progress-section { background: rgba(28, 28, 32, 0.82); border-color: rgba(129, 140, 248, 0.35); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.05); }
        [data-theme='dark'] .progress-section.collapsed { background: rgba(17, 24, 39, 0.88); border-color: rgba(129, 140, 248, 0.42); }
        [data-theme='dark'] .progress-header { background: transparent; }
        [data-theme='dark'] .progress-header:hover { background: rgba(129, 140, 248, 0.32); }
        [data-theme='dark'] #progressText { background: rgba(96, 165, 250, 0.2); color: #bfdbfe; }
        [data-theme='dark'] .progress-summary { color: rgba(235, 235, 245, 0.62); }
        [data-theme='dark'] .toggle-icon { background: rgba(99, 102, 241, 0.24); color: #e0e7ff; }
        [data-theme='dark'] .progress-header:hover .toggle-icon { background: rgba(99, 102, 241, 0.36); color: #f8fafc; }
        [data-theme='dark'] .progress-inline-track { background: rgba(96, 165, 250, 0.24); }
        [data-theme='dark'] .progress-inline-bar { background: linear-gradient(118deg, #60a5fa, #38bdf8); }
        [data-theme='dark'] .progress-inline-bar.complete { background: linear-gradient(118deg, #30d158, #32d74b); }
        [data-theme='dark'] .progress-bar-container { background: rgba(96, 165, 250, 0.22); }
        [data-theme='dark'] .progress-bar { background: linear-gradient(118deg, #60a5fa, #38bdf8); }

        [data-theme='dark'] .stats::-webkit-scrollbar-thumb { background: rgba(129, 140, 248, 0.5); }
        [data-theme='dark'] .stat-item { background: rgba(39, 39, 41, 0.72); border-color: rgba(99, 102, 241, 0.32); color: #f5f5f7; }
        [data-theme='dark'] .stat-label,
        [data-theme='dark'] .help-content p,
        [data-theme='dark'] .help-content li,
        [data-theme='dark'] .footer { color: #a1a1a6; }
        [data-theme='dark'] .help-content li:before { color: #0a84ff; }
        [data-theme='dark'] #pagesStat .stat-progress { background: rgba(96, 165, 250, 0.24); }
        [data-theme='dark'] #pagesStat .stat-progress .bar { background: linear-gradient(118deg, #60a5fa, #38bdf8); }

        [data-theme='dark'] .subject-section,
        [data-theme='dark'] .modal-content { background: rgba(28, 28, 30, 0.85); box-shadow: 0 18px 48px rgba(0,0,0,0.55); border-color: rgba(99, 102, 241, 0.28); }
        [data-theme='dark'] .subject-section:hover { box-shadow: 0 24px 60px rgba(0,0,0,0.6); }
        [data-theme='dark'] .subject-progress .progress-bar-container { background: rgba(255, 255, 255, 0.16); }
        [data-theme='dark'] .subject-progress-text { color: #f5f5f7; }

        [data-theme='dark'] .card.add-card { background: rgba(44, 44, 46, 0.9); color: #0a84ff; border-color: #0a84ff; }
        [data-theme='dark'] .card.completed {
            background: linear-gradient(150deg, rgba(34, 197, 94, 0.4), rgba(4, 120, 87, 0.48));
            color: #c8fdea;
            border-color: rgba(5, 150, 105, 0.6);
        }

        [data-theme='dark'] .card.in-progress {
            background: linear-gradient(150deg, rgba(249, 115, 22, 0.4), rgba(202, 138, 4, 0.48));
            color: #ffe8ce;
            border-color: rgba(234, 88, 12, 0.6);
        }

        [data-theme='dark'] .card.not-started {
            background: linear-gradient(150deg, rgba(239, 68, 68, 0.4), rgba(220, 38, 38, 0.5));
            color: #ffd7d7;
            border-color: rgba(220, 38, 38, 0.65);
        }
        [data-theme='dark'] .card:hover { box-shadow: 0 16px 40px rgba(0,0,0,0.55); }

        [data-theme='dark'] .hover-controls { gap: 10px; }
        [data-theme='dark'] .pages-controls { background: rgba(44, 44, 46, 0.8); border-color: rgba(255, 255, 255, 0.08); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04); }
        [data-theme='dark'] .mini-input { background: rgba(28, 28, 30, 0.92); color: #f5f5f7; border-color: rgba(255, 255, 255, 0.12); }

        [data-theme='dark'] .icon-btn,
        [data-theme='dark'] .toolbar,
        [data-theme='dark'] .filter-popover,
        [data-theme='dark'] .tool-btn { background: rgba(44, 44, 46, 0.88); color: #f5f5f7; border-color: rgba(255, 255, 255, 0.12); }
        [data-theme='dark'] .icon-btn:hover,
        [data-theme='dark'] .tool-btn:hover { background: rgba(58, 58, 60, 0.9); }
        [data-theme='dark'] .btn { background: #0a84ff; }
        [data-theme='dark'] .btn:hover { background: #0060df; }
        [data-theme='dark'] .btn-secondary { background: #636366; }
        [data-theme='dark'] .btn-secondary:hover { background: #525255; }
        [data-theme='dark'] .filter-toggle { background: rgba(44, 44, 46, 0.88); border-color: rgba(255, 255, 255, 0.12); box-shadow: 0 24px 46px rgba(0, 0, 0, 0.55); }
        [data-theme='dark'] .filter-toggle svg { stroke: #f5f5f7; }
        [data-theme='dark'] .filter-toggle.active { background: rgba(10, 132, 255, 0.38); border-color: rgba(10, 132, 255, 0.6); box-shadow: 0 28px 48px rgba(10, 132, 255, 0.42); }
        [data-theme='dark'] .filter-toggle.active svg { stroke: #f6fbff; }
        [data-theme='dark'] .filter-section-title { color: rgba(235, 235, 245, 0.7); }
        [data-theme='dark'] .filter-chip { background: rgba(118, 118, 128, 0.2); border-color: rgba(118, 118, 128, 0.32); color: #f5f5f7; }
        [data-theme='dark'] .filter-chip[data-status="completed"] { background: rgba(48, 209, 88, 0.26); border-color: rgba(48, 209, 88, 0.5); color: #30d158; }
        [data-theme='dark'] .filter-chip[data-status="in-progress"] { background: rgba(255, 159, 10, 0.26); border-color: rgba(255, 159, 10, 0.5); color: #ff9f0a; }
        [data-theme='dark'] .filter-chip[data-status="not-started"] { background: rgba(255, 69, 58, 0.26); border-color: rgba(255, 69, 58, 0.5); color: #ff453a; }
        [data-theme='dark'] .filter-chip.active { background: rgba(99, 99, 102, 0.42); border-color: rgba(99, 99, 102, 0.6); color: #e5e5ea; }
        [data-theme='dark'] .filter-reset { color: rgba(235, 235, 245, 0.82); }
        [data-theme='dark'] .filter-empty-state { color: #8e8e93; }

        [data-theme='dark'] .float-btn,
        [data-theme='dark'] .help-btn { background: rgba(28,28,30,0.72); color: rgba(235, 235, 245, 0.92); }
        [data-theme='dark'] .float-btn:hover,
        [data-theme='dark'] .help-btn:hover { background: rgba(28,28,30,0.85); }

        [data-theme='dark'] .form-input { border-color: #2c2c2e; background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .form-input:focus { border-color: #0a84ff; }

        [data-theme='dark'] .subject-section.drag-over-subject { border-color: #0a84ff; }
        [data-theme='dark'] .card-delete { background: rgba(255,255,255,0.18); color: #1c1c1e; }

        /* 三段模式选择 Popover */
        .theme-popover {
            position: fixed;
            min-width: 180px;
            background: #ffffff;
            color: #1d1d1f;
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.20);
            padding: 8px;
            z-index: 3000;
            border: 1px solid rgba(0,0,0,0.06);
            display: none;
            overflow: hidden; /* 让子项 hover 背景在圆角内裁切 */
            opacity: 0;
            transform: translateY(-6px) scale(0.98);
            transition: transform .22s cubic-bezier(0.22,0.61,0.36,1), opacity .18s ease;
        }
        .theme-popover.active { display: block; opacity: 1; transform: none; }
        .theme-popover .item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 10px; cursor: pointer;
        }
        .theme-popover .item:hover { background: #f5f5f7; }
        .theme-popover .check { margin-left: auto; opacity: 0.8; visibility: hidden; }
        .theme-popover .item.active .check { visibility: visible; }
        [data-theme='dark'] .theme-popover { background: #1c1c1e; color:#f5f5f7; border-color: rgba(255,255,255,0.08); box-shadow: 0 16px 44px rgba(0,0,0,0.6); }
        [data-theme='dark'] .theme-popover .item:hover { background: #2c2c2e; }

        /* 确保暗色下弹窗仍保留圆角（防止覆盖丢失） */
        [data-theme='dark'] .modal-content { border-radius: 16px; }

        /* 暗色下的状态色微调（Apple 风格） */
        [data-theme='dark'] .card.completed { background: linear-gradient(150deg, rgba(34, 197, 94, 0.4), rgba(4, 120, 87, 0.48)); }
        [data-theme='dark'] .card.in-progress { background: linear-gradient(150deg, rgba(249, 115, 22, 0.4), rgba(202, 138, 4, 0.48)); }
        [data-theme='dark'] .card.not-started { background: linear-gradient(150deg, rgba(239, 68, 68, 0.4), rgba(220, 38, 38, 0.5)); }

    
        /* Apple-quality: progress stat micro bar */
        #pagesStat .stat-progress { width: 100%; height: 4px; background: rgba(37, 99, 235, 0.16); border-radius: 999px; overflow: hidden; margin-top: 6px; }
        #pagesStat .stat-progress .bar { height: 100%; background: linear-gradient(118deg, #2563eb, #38bdf8); width: 0%; transition: width 0.4s cubic-bezier(0.4,0,0.2,1); }
        [data-theme='dark'] #pagesStat .stat-progress { background: rgba(96, 165, 250, 0.24); }
        [data-theme='dark'] #pagesStat .stat-progress .bar { background: linear-gradient(118deg, #60a5fa, #38bdf8); }
        .card-delete { z-index: 2; }

        /* Apple-style Toolbar Capsules */
        .toolbar { display: inline-flex; align-items: center; gap: 4px; padding: 4px; border-radius: 12px; background: rgba(255,255,255,0.72); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .toolbar > * { vertical-align: middle; }
        .toolbar .divider { width: 1px; height: 24px; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.18), transparent); margin: 0 2px; }
        .toolbar-btn {
            appearance: none;
            -webkit-appearance: none;
            cursor: pointer;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: var(--toolbar-control-size, 40px);
            min-height: var(--toolbar-control-size, 40px);
            padding: 0 20px;
            line-height: 1;
            vertical-align: middle;
            font-size: 0.9em;
            font-weight: 600;
            letter-spacing: -0.01em;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid rgba(60, 60, 67, 0.16);
            color: #1f1f21;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.92), 0 14px 28px rgba(15, 23, 42, 0.08);
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            width: auto;
            white-space: nowrap;
        }

        .toolbar-btn:hover {
            background: #ffffff;
            border-color: rgba(60, 60, 67, 0.26);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.92), 0 20px 36px rgba(15, 23, 42, 0.12);
            transform: translateY(-1px);
        }

        .toolbar-btn:active {
            transform: translateY(0);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.78), 0 10px 20px rgba(15, 23, 42, 0.1);
        }

        .toolbar-btn.outline {
            background: rgba(255, 255, 255, 0.96);
            border-color: rgba(60, 60, 67, 0.2);
            color: #1f1f21;
        }

        .toolbar-btn.primary {
            background: linear-gradient(135deg, #007aff 0%, #2563eb 100%);
            color: #fff;
            border-color: transparent;
            box-shadow: 0 18px 34px rgba(0, 122, 255, 0.28);
        }

        .toolbar-btn.primary:hover {
            box-shadow: 0 22px 42px rgba(0, 122, 255, 0.35);
        }
        [data-theme=dark] .toolbar { background: rgba(28,28,30,0.72); border-color: rgba(255,255,255,0.08); box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        [data-theme=dark] .toolbar .divider { background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.24), transparent); }
        [data-theme=dark] .toolbar-btn {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.22);
            color: rgba(235, 235, 245, 0.92);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1), 0 14px 30px rgba(0, 0, 0, 0.55);
        }

        [data-theme=dark] .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.16);
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.14), 0 20px 40px rgba(0, 0, 0, 0.6);
        }

        [data-theme=dark] .toolbar-btn.outline {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.24);
            color: rgba(235, 235, 245, 0.92);
        }

        [data-theme=dark] .toolbar-btn.primary {
            background: linear-gradient(135deg, #0a84ff 0%, #2f6bff 100%);
            border-color: transparent;
            box-shadow: 0 24px 44px rgba(10, 132, 255, 0.45);
        }

        .toolbar-btn:disabled,
        .toolbar-btn[aria-disabled="true"] {
            opacity: 0.55;
            cursor: default;
            transform: none;
            background: rgba(255, 255, 255, 0.6);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .toolbar-btn:disabled:hover,
        .toolbar-btn[aria-disabled="true"]:hover {
            background: rgba(255, 255, 255, 0.6);
            transform: none;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        [data-theme=dark] .toolbar-btn:disabled,
        [data-theme=dark] .toolbar-btn[aria-disabled="true"] {
            background: rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.06);
        }

        .toolbar-btn:focus-visible, .tool-btn:focus-visible { outline: 2px solid #0a84ff; outline-offset: 2px; }


        /* Toolbar responsive */
        @media (max-width: 768px) {
            .toolbar { width: auto; flex-wrap: wrap; }
            .toolbar .divider { display: none; }
        }

        /* Help modal scroll area uses inner scroll to preserve rounded corners */
        #helpModal .modal-content { overflow: hidden; display: flex; flex-direction: column; }
        #helpModal .help-content { max-height: 60vh; overflow: auto; padding-right: 6px; }
        #helpModal .help-content::-webkit-scrollbar { width: 8px; }
        #helpModal .help-content::-webkit-scrollbar-track { background: transparent; }
        #helpModal .help-content::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 8px; }
        [data-theme='dark'] #helpModal .help-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); }
        #helpModal .help-content { scrollbar-color: rgba(0,0,0,0.2) transparent; scrollbar-width: thin; }


        @media (prefers-reduced-motion: reduce) { * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }

        @media (max-width: 768px) { .tool-btn { height: 44px; min-width: 44px; } .tool-text-btn { min-width: 44px; padding: 0 12px; } }

    </style>
</head>
<body>
    <div class="container">
        <div class="command-hub hub-expanded" id="commandHub">
            <div class="hub-collapse-icon" aria-hidden="true">
                <span></span>
                <span></span>
                <span></span>
            </div>
            <div class="command-toolbar">
                <div class="command-title">
                    <h1>作业完成进度</h1>
                    <span class="command-subtitle-inline">Apple 级学习任务管控台 · 实时追踪每个学科</span>
                </div>
                <div class="command-actions">
                    <div class="command-utility">
                        <div class="toolbar">
                            <div class="filter-control" id="filterControl">
                                <button class="filter-toggle" id="filterToggle" aria-haspopup="true" aria-expanded="false" aria-controls="filterPopover" title="筛选作业">
                                    <svg viewBox="0 0 24 24" aria-hidden="true">
                                        <path d="M7 7h10M5 12h14M9 17h6" stroke-linecap="round" stroke-linejoin="round"></path>
                                        <circle cx="16" cy="7" r="1.5"></circle>
                                        <circle cx="8" cy="12" r="1.5"></circle>
                                        <circle cx="15" cy="17" r="1.5"></circle>
                                    </svg>
                                </button>
                                <div class="filter-popover" id="filterPopover" role="menu" aria-hidden="true">
                                    <div class="filter-section" data-group="hide">
                                        <div class="filter-section-title">隐藏</div>
                                        <div class="filter-chip-row">
                                            <button type="button" class="filter-chip" data-status="completed" data-action="hide">
                                                <span>已完成</span>
                                            </button>
                                            <button type="button" class="filter-chip" data-status="in-progress" data-action="hide">
                                                <span>进行中</span>
                                            </button>
                                            <button type="button" class="filter-chip" data-status="not-started" data-action="hide">
                                                <span>未完成</span>
                                            </button>
                                        </div>
                                    </div>
                                    <button type="button" class="filter-reset" id="filterResetBtn">重置筛选</button>
                                </div>
                            </div>
                            <button class="toolbar-btn" onclick="importConfig()" aria-label="导入配置">导入</button>
                            <button class="toolbar-btn" onclick="exportConfig()" aria-label="导出配置">导出</button>
                            <button class="toolbar-btn" id="saveImageBtn" onclick="saveAsImage()" aria-label="保存图片">保存</button>
                            <span class="divider"></span>
                            <button class="toolbar-btn outline" id="editBtn" onclick="toggleEdit()">编辑</button>
                            <span class="divider"></span>
                            <button class="toolbar-btn" id="helpBtn" onclick="openModal('helpModal')" aria-label="使用说明" title="使用说明">使用说明</button>
                            <span class="divider"></span>
                            <button class="toolbar-btn theme-toggle" id="themeToggle" aria-label="切换主题" title="切换主题">切换主题</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="progress-section">
                <div class="progress-header" onclick="toggleProgress(event)" role="button" tabindex="0" aria-controls="progressContent" aria-expanded="false" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleProgress(event);}">
                    <div class="progress-title">
                        <span>总体完成进度</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress-inline" aria-hidden="true">
                        <div class="progress-inline-track">
                            <div class="progress-inline-bar" id="progressInlineBar"></div>
                        </div>
                    </div>
                    <div class="toggle-icon" id="toggleIcon">▼</div>
                </div>
                <div class="progress-content" id="progressContent">
                    <div class="progress-meter">
                        <div class="progress-bar-container">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                        <div class="progress-summary" id="progressCaption">准备收集任务数据</div>
                    </div>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-number" id="completedCount">0</div>
                            <div class="stat-label">已完成</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="inProgressCount">0</div>
                            <div class="stat-label">进行中</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="notStartedCount">0</div>
                            <div class="stat-label">未完成</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="totalCount">0</div>
                            <div class="stat-label">总计</div>
                        </div>
                        <div class="stat-item" id="pagesStat">
                            <div class="stat-number" id="pagesPercent">0%</div>
                            <div class="stat-progress"><div class="bar" id="pagesBar"></div></div>
                            <div class="stat-label" id="pagesLabel">页数 0/0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="subjectsContainer"></div>

        <div class="footer">
            <span>Designed & Built by WitMarx</span>
            <span class="footer-divider">•</span>
            <span>© <span id="currentYear"></span></span>
        </div>
    </div>
    <!-- 使用说明弹窗 -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-title">使用说明</div>
            <div class="help-content">
                <h3>🧭 快速上手</h3>
                <ul>
                    <li>点卡片切换状态：未完成 → 进行中 → 已完成</li>
                    <li>进行中任务可用滑块或百分比输入（控件随时可用）</li>
                    <li>可录入“已页/总页”，自动按页数计算完成度；仅填“总页”也可参与汇总</li>
                </ul>
                <h3>✏️ 编辑与排序</h3>
                <ul>
                    <li>点右上“编辑”进入编辑模式：可增删学科/作业，支持拖拽排序</li>
                    <li>编辑模式下控件默认展开，便于批量录入页数</li>
                </ul>
                <h3>📊 汇总与统计</h3>
                <ul>
                    <li>底部显示总体完成度；展开可查看任务统计与“页数”汇总</li>
                    <li>“页数”卡片带细进度条，展示已完成页/总页</li>
                </ul>
                <h3>💾 配置与分享</h3>
                <ul>
                    <li>导出/导入配置：备份或在设备间同步进度</li>
                    <li>右上“保存图片”将页面保存为 PNG，便于分享/打印</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('helpModal')">我知道了</button>
            </div>
        </div>
    </div>

    <!-- 添加学科弹窗 -->
    <div class="modal" id="addSubjectModal">
        <div class="modal-content">
            <div class="modal-title">添加学科</div>
            <div class="form-group">
                <label class="form-label">学科名称</label>
                <input type="text" class="form-input" id="subjectTitle">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('addSubjectModal')">取消</button>
                <button class="btn" onclick="confirmAddSubject()">确定</button>
            </div>
        </div>
    </div>

    <div class="theme-popover" id="themePopover" role="menu" aria-hidden="true">
        <div class="item" data-mode="auto"><span>跟随系统</span><span class="check">✓</span></div>
        <div class="item" data-mode="light"><span>浅色</span><span class="check">✓</span></div>
        <div class="item" data-mode="dark"><span>深色</span><span class="check">✓</span></div>
    </div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <script src="default-config.js"></script>
    <script>
        let editMode = false;
        let currentSubjectIndex = -1;
        const STATUS_LABELS = {
            'completed': '已完成',
            'in-progress': '进行中',
            'not-started': '未完成'
        };
        const STATUS_ORDER = ['completed', 'in-progress', 'not-started'];

        const filterState = {
            hidden: new Set()
        };

        const progressSectionEl = document.querySelector('.progress-section');
        const progressContentEl = document.getElementById('progressContent');
        const commandHubEl = document.getElementById('commandHub');
        const progressHeaderEl = document.querySelector('.progress-header');
        const toggleIconEl = document.getElementById('toggleIcon');
        const isInitiallyCollapsed = !!(progressContentEl && progressContentEl.classList.contains('collapsed'));
        let isProgressCollapsed = isInitiallyCollapsed;
        let userPreferredProgressCollapsed = isInitiallyCollapsed;
        let isCommandHubCollapsed = false;
        let isCommandHubFloating = false;
        let collapseOnScrollArmed = false;
        let lastManualExpandScrollY = 0;

        function syncProgressCollapseState() {
            if (progressContentEl) {
                progressContentEl.classList.toggle('collapsed', isProgressCollapsed);
            }
            if (progressSectionEl) {
                progressSectionEl.classList.toggle('collapsed', isProgressCollapsed);
            }
            if (toggleIconEl) {
                toggleIconEl.classList.toggle('collapsed', isProgressCollapsed);
            }
            if (progressHeaderEl) {
                progressHeaderEl.setAttribute('aria-expanded', String(!isProgressCollapsed));
            }
        }

        function setProgressCollapsed(collapsed, { force = false } = {}) {
            const desired = !!collapsed;
            if (!force && desired === isProgressCollapsed) return;

            isProgressCollapsed = desired;
            if (!force) {
                userPreferredProgressCollapsed = desired;
            }

            syncProgressCollapseState();
        }

        function syncCommandHubCollapseState() {
            if (!commandHubEl) return;
            commandHubEl.classList.toggle('hub-collapsed', isCommandHubCollapsed);
            commandHubEl.classList.toggle('hub-expanded', !isCommandHubCollapsed);
            commandHubEl.setAttribute('aria-expanded', isCommandHubCollapsed ? 'false' : 'true');

            if (isCommandHubCollapsed) {
                commandHubEl.setAttribute('role', 'button');
                commandHubEl.setAttribute('tabindex', '0');
                commandHubEl.setAttribute('aria-label', '展开控制栏');
                commandHubEl.setAttribute('title', '展开控制栏');
            } else {
                commandHubEl.removeAttribute('role');
                commandHubEl.removeAttribute('aria-label');
                commandHubEl.removeAttribute('tabindex');
                commandHubEl.removeAttribute('title');
            }

            if (progressHeaderEl) {
                const disabled = isCommandHubCollapsed;
                progressHeaderEl.setAttribute('aria-disabled', disabled ? 'true' : 'false');
                progressHeaderEl.setAttribute('tabindex', disabled ? '-1' : '0');
            }
        }

        function setCommandHubCollapsed(collapsed, { force = false } = {}) {
            let desired = !!collapsed;
            if (!isCommandHubFloating && desired) {
                desired = false;
            }

            if (desired === isCommandHubCollapsed) {
                if (!force) return;
            } else {
                isCommandHubCollapsed = desired;
            }

            syncCommandHubCollapseState();

            collapseOnScrollArmed = false;

            if (!isCommandHubCollapsed) {
                setProgressCollapsed(userPreferredProgressCollapsed, { force: true });
            }
        }

        syncProgressCollapseState();
        syncCommandHubCollapseState();

        function armCollapseOnScroll() {
            collapseOnScrollArmed = true;
            lastManualExpandScrollY = window.scrollY;
        }

        function detectCommandHubFloating() {
            if (!commandHubEl) return false;
            const style = getComputedStyle(commandHubEl);
            const position = style.position;
            if (position !== 'sticky' && position !== 'fixed') {
                return false;
            }
            const topOffset = parseFloat(style.top) || 0;
            if (window.scrollY + 1 <= topOffset) {
                return false;
            }
            const rectTop = commandHubEl.getBoundingClientRect().top;
            return rectTop <= topOffset + 1;
        }

        function handleFloatingClick(event) {
            if (!isCommandHubFloating || !isCommandHubCollapsed) return;
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            setCommandHubCollapsed(false, { force: true });
            armCollapseOnScroll();
        }

        if (commandHubEl) {
            commandHubEl.addEventListener('click', handleFloatingClick);
            commandHubEl.addEventListener('keydown', handleCommandHubKeydown);
        }

        function handleCommandHubKeydown(event) {
            if (!isCommandHubCollapsed) return;
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                setCommandHubCollapsed(false, { force: true });
                armCollapseOnScroll();
            }
        }

        function updateFloatingState() {
            if (!commandHubEl) return;
            const shouldFloat = detectCommandHubFloating();

            if (shouldFloat && !isCommandHubFloating) {
                isCommandHubFloating = true;
                commandHubEl.classList.add('floating-mode');
                setCommandHubCollapsed(true, { force: true });
            } else if (!shouldFloat && isCommandHubFloating) {
                isCommandHubFloating = false;
                commandHubEl.classList.remove('floating-mode');
                setCommandHubCollapsed(false, { force: true });
            } else if (!shouldFloat) {
                setCommandHubCollapsed(false, { force: true });
            }
        }

        updateFloatingState();

        function getStatusLabel(status) {
            return STATUS_LABELS[status] || '未完成';
        }

        function shouldShowHomework(hw) {
            if (!hw) return true;
            const status = hw.status || 'not-started';
            if (filterState.hidden.has(status)) {
                return false;
            }
            return true;
        }

        function updateFilterSummary() {
            const toggleBtn = document.getElementById('filterToggle');
            if (!toggleBtn) return;

            const defaultLabel = '筛选作业';
            let description = defaultLabel;
            if (filterState.hidden.size) {
                const list = STATUS_ORDER.filter(status => filterState.hidden.has(status)).map(getStatusLabel);
                description = `隐藏${list.join('、')}`;
            }
            const ariaLabel = filterState.hidden.size ? `${defaultLabel}（${description}）` : defaultLabel;
            toggleBtn.setAttribute('aria-label', ariaLabel);
            if (filterState.hidden.size) {
                toggleBtn.setAttribute('title', description);
            } else {
                toggleBtn.removeAttribute('title');
            }
            toggleBtn.classList.toggle('active', filterState.hidden.size > 0);
        }

        function syncFilterChipStates() {
            const chips = document.querySelectorAll('.filter-chip');
            chips.forEach(chip => {
                const status = chip.dataset.status;
                const action = chip.dataset.action;
                let active = false;
                if (action === 'hide') {
                    active = filterState.hidden.has(status);
                }
                chip.classList.toggle('active', active);
            });
        }

        function openFilterPopover() {
            const popover = document.getElementById('filterPopover');
            const toggleBtn = document.getElementById('filterToggle');
            if (!popover || !toggleBtn) return;
            popover.classList.add('open');
            popover.setAttribute('aria-hidden', 'false');
            toggleBtn.setAttribute('aria-expanded', 'true');
            syncFilterChipStates();
        }

        function closeFilterPopover() {
            const popover = document.getElementById('filterPopover');
            const toggleBtn = document.getElementById('filterToggle');
            if (!popover || !toggleBtn) return;
            popover.classList.remove('open');
            popover.setAttribute('aria-hidden', 'true');
            toggleBtn.setAttribute('aria-expanded', 'false');
        }

        function setupFilterControls() {
            const toggleBtn = document.getElementById('filterToggle');
            const popover = document.getElementById('filterPopover');
            const resetBtn = document.getElementById('filterResetBtn');
            if (!toggleBtn || !popover) return;

            const togglePopover = () => {
                if (popover.classList.contains('open')) {
                    closeFilterPopover();
                } else {
                    openFilterPopover();
                }
            };

            toggleBtn.addEventListener('click', (event) => {
                event.stopPropagation();
                togglePopover();
            });

            const handleChipClick = (event) => {
                const chip = event.currentTarget;
                const status = chip.dataset.status;
                const action = chip.dataset.action;
                if (action === 'hide') {
                    if (filterState.hidden.has(status)) {
                        filterState.hidden.delete(status);
                    } else {
                        filterState.hidden.add(status);
                    }
                }
                updateFilterSummary();
                syncFilterChipStates();
                renderSubjects();
            };

            popover.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', handleChipClick);
            });

            if (resetBtn) {
                resetBtn.addEventListener('click', () => {
                    filterState.hidden.clear();
                    updateFilterSummary();
                    syncFilterChipStates();
                    renderSubjects();
                    closeFilterPopover();
                });
            }

            document.addEventListener('click', (event) => {
                if (!popover.classList.contains('open')) return;
                if (popover.contains(event.target) || toggleBtn.contains(event.target)) return;
                closeFilterPopover();
            });

            document.addEventListener('keydown', (event) => {
                if (event.key === 'Escape' && popover.classList.contains('open')) {
                    closeFilterPopover();
                    toggleBtn.focus();
                }
            });

            updateFilterSummary();
            syncFilterChipStates();
        }

        function cloneSubjectsConfig(config) {
            if (!Array.isArray(config)) return [];
            return config.map(subject => ({
                name: subject?.name || '未命名学科',
                homeworks: Array.isArray(subject?.homeworks)
                    ? subject.homeworks.map(hw => ({
                        title: hw?.title || '未命名作业',
                        status: hw?.status || 'not-started',
                        pagesDone: hw?.pagesDone,
                        pagesTotal: hw?.pagesTotal
                    }))
                    : []
            }));
        }

        const STORAGE_KEY = 'homeworkSubjectsConfig';

        function loadInitialSubjects() {
            if (typeof window !== 'undefined' && window.localStorage) {
                try {
                    const stored = window.localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            return cloneSubjectsConfig(parsed);
                        }
                    }
                } catch (error) {
                    console.warn('读取本地配置失败：', error);
                }
            }
            return cloneSubjectsConfig(window.defaultSubjects);
        }

        function persistSubjects() {
            if (typeof window === 'undefined' || !window.localStorage) return;
            try {
                window.localStorage.setItem(STORAGE_KEY, JSON.stringify(subjects));
            } catch (error) {
                console.warn('保存本地配置失败：', error);
            }
        }

        function resetSubjectsToDefault() {
            subjects = cloneSubjectsConfig(window.defaultSubjects);
            renderSubjects();
        }

        window.resetSubjectsToDefault = resetSubjectsToDefault;

        let subjects = loadInitialSubjects();

        function renderSubjects() {
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = '';

            subjects.forEach((subject, subjectIndex) => {
                const section = document.createElement('div');
                section.className = 'subject-section' + (editMode ? ' edit-mode draggable-subject' : '');
                section.draggable = editMode;
                section.dataset.subjectIndex = subjectIndex;

                const subjectPercent = getSubjectProgressPercent(subject);
                const visibleHomeworks = subject.homeworks
                    .map((hw, hwIndex) => ({ hw, hwIndex }))
                    .filter(({ hw }) => shouldShowHomework(hw));

                const cardsMarkup = visibleHomeworks.map(({ hw, hwIndex }) => `
                            <div class="card ${hw.status} ${editMode ? 'draggable' : ''}"
                                 draggable="${editMode}"
                                 data-subject-index="${subjectIndex}"
                                 data-hw-index="${hwIndex}"
                                 onclick="toggleStatus(${subjectIndex}, ${hwIndex})">
                                <button class="card-delete" onclick="event.stopPropagation(); deleteHomework(${subjectIndex}, ${hwIndex})">×</button>
                                <div class="card-title">${hw.title}</div>
                                <div class="card-status">${getStatusText(hw)}</div>
                                <div class="hover-controls" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">
                                  <div class="pages-controls" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">
                                    <input type="number" class="mini-input page-input" min="0" placeholder="已页"
                                           value="${(hw.pagesDone != null ? hw.pagesDone : "")}"
                                           oninput="updateHwPages(${subjectIndex}, ${hwIndex}, 'done', this.value)">
                                    <span class="slash">/</span>
                                    <input type="number" class="mini-input page-input" min="0" placeholder="总页"
                                           value="${(hw.pagesTotal != null ? hw.pagesTotal : "")}"
                                           oninput="updateHwPages(${subjectIndex}, ${hwIndex}, 'total', this.value)">
                                  </div>
                                </div>

                            </div>
                        `).join('');

                const emptyStateMarkup = (!visibleHomeworks.length) ? '<div class="filter-empty-state">暂无符合筛选条件的作业</div>' : '';

                section.innerHTML = `
                    <div class="subject-header">
                        <h2 class="subject-title">${subject.name}</h2>
                        <div class="subject-actions">
                            <button class="icon-btn" onclick="addHomework(${subjectIndex})">+ 作业</button>
                            <button class="icon-btn delete" onclick="deleteSubject(${subjectIndex})">删除学科</button>
                        </div>
                    </div>
                    <div class="subject-progress">
                      <div class="progress-bar-container">
                        <div class="progress-bar subject-progress-bar ${subjectPercent === 100 ? 'complete' : ''}" data-subject-index="${subjectIndex}" style="width:${subjectPercent}%"></div>
                      </div>
                      <div class="subject-progress-text" data-subject-index="${subjectIndex}">${subjectPercent}%</div>
                    </div>
                    <div class="cards-grid" data-subject-index="${subjectIndex}">
                        ${cardsMarkup}
                        ${emptyStateMarkup}
                        <div class="card add-card" onclick="addHomework(${subjectIndex})">
                            + 添加作业
                        </div>
                    </div>
                `;

                container.appendChild(section);
            });

            if (editMode) {
                const addSection = document.createElement('div');
                addSection.className = 'subject-section';
                addSection.innerHTML = `
                    <button class="btn" style="width: 100%;" onclick="openAddSubjectModal()">+ 添加学科</button>
                `;
                container.appendChild(addSection);
            }

            updateProgress();
            setupDragAndDrop();
            setupSubjectDragAndDrop();
            updateFilterSummary();
            persistSubjects();
        }

                // 进度计算：最近一次编辑优先（pages 或 manual），缺省时按状态兜底
        function clampPercent(n) { return Math.max(0, Math.min(100, Math.round(Number(n) || 0))); }

        function getHomeworkProgress(hw) {
            if (!hw || !hw.status) return 0;
            if (hw.status === "completed") return 100;
            const pd = Number(hw.pagesDone), pt = Number(hw.pagesTotal);
            const pagesReady = Number.isFinite(pd) && Number.isFinite(pt) && pt > 0;
            if (pagesReady) return clampPercent(pd / pt * 100);
            return 0;
        }

        function getSubjectProgressPercent(subject) {
            if (!subject || !Array.isArray(subject.homeworks) || subject.homeworks.length === 0) return 0;
            let pagesDoneSum = 0;
            let pagesTotalSum = 0;
            subject.homeworks.forEach(hw => {
                const pt = Number(hw.pagesTotal);
                if (Number.isFinite(pt) && pt > 0) {
                    let pd = Number(hw.pagesDone);
                    if (!Number.isFinite(pd)) pd = (hw.status === "completed") ? pt : 0;
                    pagesDoneSum += Math.min(pd, pt);
                    pagesTotalSum += pt;
                }
            });
            return pagesTotalSum > 0 ? Math.round((pagesDoneSum / pagesTotalSum) * 100) : 0;
        }

        function getStatusText(hw) {
            if (!hw) return "未完成";
            if (hw.status === "completed") return "已完成";
            if (hw.status === "not-started") return "未完成";
            return "进行中 " + getHomeworkProgress(hw) + "%";
        }
        function syncStatusWithPages(hw) {
            const pt = Number(hw.pagesTotal);
            const pd = Number(hw.pagesDone);
            const hasPT = Number.isFinite(pt) && pt > 0;
            if (!hasPT) return;
            if (!Number.isFinite(pd) || pd <= 0) hw.status = 'not-started';
            else if (pd >= pt) hw.status = 'completed';
            else hw.status = 'in-progress';
        }

        function updateHwPages(subjectIndex, hwIndex, which, value) {
            const hw = subjects[subjectIndex].homeworks[hwIndex];
            const card = document.querySelector(`.card[data-subject-index="${subjectIndex}"][data-hw-index="${hwIndex}"]`);
            if (value === '' || value == null) {
                if (which === 'done') delete hw.pagesDone;
                if (which === 'total') delete hw.pagesTotal;
                syncStatusWithPages(hw);
                if (card) {
                    const sel = which === 'done' ? '.pages-controls input[placeholder="已页"]' : '.pages-controls input[placeholder="总页"]';
                    const inp = card.querySelector(sel);
                    if (inp) inp.value = '';
                    const p = getHomeworkProgress(hw);
                    const statusEl = card.querySelector('.card-status');
                    if (statusEl) statusEl.textContent = getStatusText(hw);
                    card.classList.remove('not-started','in-progress','completed');
                    card.classList.add(hw.status);
                }
                updateProgress();
                return;
            }
            const v = Math.max(0, Math.floor(Number(value) || 0));
            if (which === "done") hw.pagesDone = v;
            if (which === "total") hw.pagesTotal = v;
            syncStatusWithPages(hw);
            if (card) {
                const doneInput = card.querySelector('.pages-controls input[placeholder="已页"]');
                const totalInput = card.querySelector('.pages-controls input[placeholder="总页"]');
                if (doneInput && which === "done") doneInput.value = String(v);
                if (totalInput && which === "total") totalInput.value = String(v);
                const statusEl = card.querySelector('.card-status');
                    const p = getHomeworkProgress(hw);
                if (statusEl) statusEl.textContent = getStatusText(hw);
                card.classList.remove('not-started','in-progress','completed');
                card.classList.add(hw.status);
            }
            updateProgress();
        }

        function toggleEdit() {
            editMode = !editMode;
            const btn = document.getElementById('editBtn');
            btn.textContent = editMode ? '完成' : '编辑';
            if (btn) { btn.classList.remove('primary','outline'); btn.classList.add(editMode ? 'primary' : 'outline'); }
            renderSubjects();
        }

        function toggleStatus(subjectIndex, hwIndex) {
            if (editMode) return;

            const homework = subjects[subjectIndex].homeworks[hwIndex];
            const statusCycle = ['not-started', 'in-progress', 'completed'];
            const currentIndex = statusCycle.indexOf(homework.status);
            homework.status = statusCycle[(currentIndex + 1) % statusCycle.length];

            const pt = Number(homework.pagesTotal);
            if (Number.isFinite(pt) && pt > 0) {
                if (homework.status === 'completed') homework.pagesDone = pt;
                else if (homework.status === 'not-started') homework.pagesDone = 0;
            }

            // Add pulse animation on status change
            const card = document.querySelector(`.card[data-subject-index="${subjectIndex}"][data-hw-index="${hwIndex}"]`);
            if (card) {
                card.classList.add('status-changing');
                setTimeout(() => card.classList.remove('status-changing'), 400);
            }

            renderSubjects();
        }

        function addHomework(subjectIndex) {
            currentSubjectIndex = subjectIndex;
            openModal('addHomeworkModal');
        }

        function confirmAddHomework() {
            const title = document.getElementById('homeworkTitle').value.trim();
            const status = document.getElementById('homeworkStatus').value;

            if (!title) {
                alert('请输入作业名称');
                return;
            }

            subjects[currentSubjectIndex].homeworks.push({ title, status });
            document.getElementById('homeworkTitle').value = '';
            closeModal('addHomeworkModal');
            renderSubjects();
        }

        function deleteHomework(subjectIndex, hwIndex) {
            if (confirm('确定要删除这项作业吗？')) {
                subjects[subjectIndex].homeworks.splice(hwIndex, 1);
                renderSubjects();
            }
        }

        function openAddSubjectModal() {
            openModal('addSubjectModal');
        }

        function confirmAddSubject() {
            const name = document.getElementById('subjectTitle').value.trim();

            if (!name) {
                alert('请输入学科名称');
                return;
            }

            subjects.push({ name, homeworks: [] });
            document.getElementById('subjectTitle').value = '';
            closeModal('addSubjectModal');
            renderSubjects();
        }

        function deleteSubject(subjectIndex) {
            if (confirm('确定要删除整个学科吗？')) {
                subjects.splice(subjectIndex, 1);
                renderSubjects();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function exportConfig() {
            const config = {
                version: "1.1",
                exportDate: new Date().toISOString(),
                subjects: subjects
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `作业配置_${new Date().toLocaleDateString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importConfig() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    if (config.subjects && Array.isArray(config.subjects)) {
                        if (confirm('导入配置将替换当前所有数据，是否继续？')) {
                            subjects = cloneSubjectsConfig(config.subjects);
                            renderSubjects();
                        }
                    } else {
                        alert('配置文件格式不正确');
                    }
                } catch (error) {
                    alert('读取配置文件失败：' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function updateProgress() {
            let totalTasks = 0;
            let completed = 0;
            let inProgress = 0;
            let notStarted = 0;
            let sumProgress = 0;
            let pagesDoneSum = 0;
            let pagesTotalSum = 0;

            subjects.forEach(subject => {
                subject.homeworks.forEach(hw => {
                    totalTasks++;
                    if (hw.status === "completed") completed++;
                    else if (hw.status === "in-progress") inProgress++;
                    else if (hw.status === "not-started") notStarted++;

                    const p = getHomeworkProgress(hw);
                    sumProgress += p;

                    const pt = Number(hw.pagesTotal);
                    if (Number.isFinite(pt) && pt > 0) {
                        let pd = Number(hw.pagesDone);
                        if (!Number.isFinite(pd)) pd = (hw.status === "completed") ? pt : 0;
                        pagesDoneSum += Math.min(pd, pt);
                        pagesTotalSum += pt;
                    }
                });
            });

            const overall = totalTasks > 0 ? Math.round(sumProgress / totalTasks) : 0;
            const overallBar = document.getElementById('progressBar');
            if (overallBar) {
                const prevWidth = parseFloat(overallBar.style.width) || 0;
                overallBar.style.width = overall + "%";
                overallBar.classList.toggle('complete', overall === 100);
                if (Math.abs(overall - prevWidth) > 0.1) {
                    overallBar.classList.add('animating');
                    setTimeout(() => overallBar.classList.remove('animating'), 1000);
                }
            }
            const inlineBar = document.getElementById('progressInlineBar');
            if (inlineBar) {
                const prevWidth = parseFloat(inlineBar.style.width) || 0;
                inlineBar.style.width = overall + "%";
                inlineBar.classList.toggle('complete', overall === 100);
                if (Math.abs(overall - prevWidth) > 0.1) {
                    inlineBar.classList.add('animating');
                    setTimeout(() => inlineBar.classList.remove('animating'), 1000);
                }
            }
            document.getElementById('progressText').textContent = overall + "%";
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('notStartedCount').textContent = notStarted;
            document.getElementById('totalCount').textContent = totalTasks;

            const pagesPct = pagesTotalSum > 0 ? Math.round((pagesDoneSum / pagesTotalSum) * 100) : 0;
            const pPctEl = document.getElementById('pagesPercent');
            const pLblEl = document.getElementById('pagesLabel');
            if (pPctEl) pPctEl.textContent = pagesPct + "%";
            if (pLblEl) pLblEl.textContent = `页数 ${pagesDoneSum}/${pagesTotalSum}`;
            const pBarEl = document.getElementById('pagesBar');
            if (pBarEl) pBarEl.style.width = pagesPct + "%";

            const captionEl = document.getElementById('progressCaption');
            if (captionEl) {
                if (totalTasks > 0) {
                    const segments = [`${completed}/${totalTasks} 项完成`];
                    if (pagesTotalSum > 0) {
                        segments.push(`页数 ${pagesDoneSum}/${pagesTotalSum}`);
                    }
                    captionEl.textContent = segments.join(' · ');
                } else {
                    captionEl.textContent = '还没有录入任务';
                }
            }

            if (typeof updateSubjectProgressBars === 'function') updateSubjectProgressBars();
        }

        function updateSubjectProgressBars() {
            subjects.forEach((subject, idx) => {
                const pct = getSubjectProgressPercent(subject);
                const bar = document.querySelector(`.subject-progress-bar[data-subject-index="${idx}"]`);
                const lbl = document.querySelector(`.subject-progress-text[data-subject-index="${idx}"]`);
                if (bar) { bar.style.width = pct + '%'; bar.classList.toggle('complete', pct === 100); }
                if (lbl) lbl.textContent = pct + '%';
            });
        }

        function toggleProgress(evt) {
            if (evt) evt.stopPropagation();
            if (isCommandHubCollapsed) return;
            setProgressCollapsed(!isProgressCollapsed);
        }

        function setupDragAndDrop() {
            if (!editMode) return;

            const draggableCards = document.querySelectorAll('.card.draggable');

            draggableCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedElement = null;
        let draggedSubjectIndex = null;
        let draggedHwIndex = null;

        function handleDragStart(e) {
            draggedElement = this;
            draggedSubjectIndex = parseInt(this.dataset.subjectIndex);
            draggedHwIndex = parseInt(this.dataset.hwIndex);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetCard = e.target.closest('.card.draggable');
            if (targetCard && targetCard !== draggedElement) {
                targetCard.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(e) {
            const targetCard = e.target.closest('.card.draggable');
            if (targetCard) {
                targetCard.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetCard = e.target.closest('.card.draggable');
            if (!targetCard || targetCard === draggedElement) {
                return false;
            }

            const targetSubjectIndex = parseInt(targetCard.dataset.subjectIndex);
            const targetHwIndex = parseInt(targetCard.dataset.hwIndex);

            if (draggedSubjectIndex === targetSubjectIndex) {
                const subject = subjects[draggedSubjectIndex];
                const draggedHomework = subject.homeworks[draggedHwIndex];

                subject.homeworks.splice(draggedHwIndex, 1);
                subject.homeworks.splice(targetHwIndex, 0, draggedHomework);

                renderSubjects();
            }

            return false;
        }

        async function saveAsImage() {
            const button = document.getElementById('saveImageBtn');
            let originalText = '';
            if (button) {
                button.disabled = true;
                originalText = button.textContent;
                button.textContent = '处理中...';
            }

            const progressSection = document.querySelector('.progress-section');
            const helpBtn = document.getElementById('helpBtn');
            const saveBtn = document.getElementById('saveImageBtn');
            const containerEl = document.querySelector('.container');
            const subjectsEl = document.getElementById('subjectsContainer');
            const commandHub = document.getElementById('commandHub');

            const prevStyles = progressSection ? {
                position: progressSection.style.position,
                bottom: progressSection.style.bottom,
                left: progressSection.style.left,
                right: progressSection.style.right,
                transform: progressSection.style.transform,
                width: progressSection.style.width,
                top: progressSection.style.top,
                margin: progressSection.style.margin
            } : null;
            const prevContainerGap = containerEl ? containerEl.style.gap : '';
            const prevSubjectsGap = subjectsEl ? subjectsEl.style.gap : '';
            const prevHubMarginBottom = commandHub ? commandHub.style.marginBottom : '';
            const collapsedBeforeSave = isProgressCollapsed;
            const hubCollapsedBeforeSave = isCommandHubCollapsed;
            const wasFloatingBeforeSave = isCommandHubFloating;
            let layoutRestored = false;

            const restoreLayout = () => {
                if (layoutRestored) return;
                if (progressSection && prevStyles) {
                    progressSection.style.position = prevStyles.position || '';
                    progressSection.style.bottom = prevStyles.bottom || '';
                    progressSection.style.left = prevStyles.left || '';
                    progressSection.style.right = prevStyles.right || '';
                    progressSection.style.transform = prevStyles.transform || '';
                    progressSection.style.width = prevStyles.width || '';
                    progressSection.style.top = prevStyles.top || '';
                    progressSection.style.margin = prevStyles.margin || '';
                }
                if (containerEl) containerEl.style.gap = prevContainerGap || '';
                if (subjectsEl) subjectsEl.style.gap = prevSubjectsGap || '';
                if (commandHub) commandHub.style.marginBottom = prevHubMarginBottom || '';
                if (collapsedBeforeSave) setProgressCollapsed(true, { force: true });
                if (wasFloatingBeforeSave) {
                    setCommandHubCollapsed(hubCollapsedBeforeSave, { force: true });
                } else {
                    setCommandHubCollapsed(false, { force: true });
                }
                layoutRestored = true;
            };

            try {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(script);
                await new Promise((resolve, reject) => { script.onload = resolve; script.onerror = reject; });

                if (progressSection) {
                    progressSection.style.position = 'relative';
                    progressSection.style.bottom = 'auto';
                    progressSection.style.left = 'auto';
                    progressSection.style.right = 'auto';
                    progressSection.style.transform = 'none';
                    progressSection.style.width = '100%';
                    progressSection.style.top = 'auto';
                    progressSection.style.margin = '0 auto';
                }
                if (containerEl) containerEl.style.gap = '48px';
                if (subjectsEl) subjectsEl.style.gap = '32px';
                if (commandHub) commandHub.style.marginBottom = '48px';
                if (collapsedBeforeSave) setProgressCollapsed(false, { force: true });
                setCommandHubCollapsed(false, { force: true });
                if (helpBtn) helpBtn.style.display = 'none';
                if (saveBtn) saveBtn.style.display = 'none';

                const bg = getComputedStyle(document.body).backgroundColor;
                const canvas = await html2canvas(document.body, { backgroundColor: bg, scale: 2, logging: false, useCORS: true });

                restoreLayout();
                if (helpBtn) helpBtn.style.display = '';
                if (saveBtn) saveBtn.style.display = '';

                canvas.toBlob((blob) => {
                    if (!blob) {
                        alert('保存图片失败：生成图像出错');
                        if (button) { button.disabled = false; button.textContent = originalText || '保存图片'; }
                        return;
                    }
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `作业进度_${new Date().toLocaleDateString()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    if (button) { button.disabled = false; button.textContent = originalText || '保存图片'; }
                });
            } catch (error) {
                restoreLayout();
                if (helpBtn) helpBtn.style.display = '';
                if (saveBtn) saveBtn.style.display = '';
                alert('保存图片失败：' + error.message);
                if (button) { button.disabled = false; button.textContent = originalText || '保存图片'; }
            }
        }

        function setupSubjectDragAndDrop() {
            if (!editMode) return;

            const draggableSections = document.querySelectorAll('.subject-section.draggable-subject');

            draggableSections.forEach(section => {
                section.addEventListener('dragstart', handleSubjectDragStart);
                section.addEventListener('dragend', handleSubjectDragEnd);
                section.addEventListener('dragover', handleSubjectDragOver);
                section.addEventListener('drop', handleSubjectDrop);
                section.addEventListener('dragleave', handleSubjectDragLeave);
            });
        }

        let draggedSubject = null;
        let draggedSubjectIdx = null;

        function handleSubjectDragStart(e) {
            if (e.target.classList.contains('card')) return;

            draggedSubject = this;
            draggedSubjectIdx = parseInt(this.dataset.subjectIndex);
            this.classList.add('dragging-subject');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleSubjectDragEnd(e) {
            this.classList.remove('dragging-subject');
            document.querySelectorAll('.subject-section').forEach(section => {
                section.classList.remove('drag-over-subject');
            });
        }

        function handleSubjectDragOver(e) {
            if (!draggedSubject || e.target.closest('.card')) return;

            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetSection = e.target.closest('.subject-section.draggable-subject');
            if (targetSection && targetSection !== draggedSubject) {
                targetSection.classList.add('drag-over-subject');
            }

            return false;
        }

        function handleSubjectDragLeave(e) {
            const targetSection = e.target.closest('.subject-section.draggable-subject');
            if (targetSection && !targetSection.contains(e.relatedTarget)) {
                targetSection.classList.remove('drag-over-subject');
            }
        }

        function handleSubjectDrop(e) {
            if (!draggedSubject || e.target.closest('.card')) return;

            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetSection = e.target.closest('.subject-section.draggable-subject');
            if (!targetSection || targetSection === draggedSubject) {
                return false;
            }

            const targetIdx = parseInt(targetSection.dataset.subjectIndex);

            const draggedSubjectData = subjects[draggedSubjectIdx];
            subjects.splice(draggedSubjectIdx, 1);
            subjects.splice(targetIdx, 0, draggedSubjectData);

            renderSubjects();

            return false;
        }
        setupFilterControls();
        renderSubjects();

        // 主题切换（三段：跟随系统/浅色/深色），带弹出菜单与持久化
        (function () {
            const toggles = Array.from(document.querySelectorAll('.theme-toggle'));
            const popover = document.getElementById('themePopover');
            const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

            const sun = () => '<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="5" fill="currentColor"/><g fill="currentColor"><rect x="11" y="2" width="2" height="3"/><rect x="11" y="19" width="2" height="3"/><rect x="2" y="11" width="3" height="2"/><rect x="19" y="11" width="3" height="2"/><rect x="4.2" y="4.2" width="2" height="2" transform="rotate(-45 5.2 5.2)"/><rect x="17.8" y="17.8" width="2" height="2" transform="rotate(-45 18.8 18.8)"/><rect x="4.2" y="17.8" width="2" height="2" transform="rotate(45 5.2 18.8)"/><rect x="17.8" y="4.2" width="2" height="2" transform="rotate(45 18.8 5.2)"/></g></svg>';
            const moon = () => '<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8z" fill="currentColor"/></svg>';

            function getSavedMode() {
                try { return localStorage.getItem('themeMode') || 'auto'; } catch(e) { return 'auto'; }
            }
            function setSavedMode(mode) {
                try { localStorage.setItem('themeMode', mode); } catch(e) {}
            }
            function resolvedTheme(mode) {
                if (mode === 'light') return 'light';
                if (mode === 'dark') return 'dark';
                return (media && media.matches) ? 'dark' : 'light';
            }
            function apply(mode) {
                const t = resolvedTheme(mode);
                document.documentElement.setAttribute('data-theme', t);
                setSavedMode(mode);
                // 更新按钮图标与提示
                toggles.forEach(btn => {
                    btn.textContent = '切换主题';
                    const label = mode === 'auto' ? '跟随系统' : (mode === 'dark' ? '深色' : '浅色');
                    btn.setAttribute('aria-label', '切换主题（' + label + '）');
                    btn.setAttribute('title', '切换主题（' + label + '）');
                });
                // 更新弹窗选中项
                if (popover) {
                    popover.querySelectorAll('.item').forEach(it => {
                        it.classList.toggle('active', it.getAttribute('data-mode') === mode);
                    });
                }
            }
            function openPopoverNear(btn) {
                if (!popover || !btn) return;
                const r = btn.getBoundingClientRect();
                const gap = 8;
                const top = r.bottom + gap;
                let left = r.right - 180; // right aligned to button
                left = Math.max(12, Math.min(left, window.innerWidth - 192));
                popover.style.top = Math.round(top) + 'px';
                popover.style.left = Math.round(left) + 'px';
                popover.classList.add('active');
                popover.setAttribute('aria-hidden', 'false');
            }
            function closePopover() {
                if (!popover) return;
                popover.classList.remove('active');
                popover.setAttribute('aria-hidden', 'true');
            }

            // Init
            let mode = getSavedMode();
            apply(mode);

            // Toggle click：单击直接切换（light ↔ dark），Alt/右键打开菜单选择（含跟随系统）
            toggles.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (e.altKey) {
                        // Alt+Click 显示/隐藏菜单
                        if (popover && popover.classList.contains('active')) closePopover();
                        else openPopoverNear(btn);
                        return;
                    }
                    // 直接在浅/深之间切换；若当前为 auto，则切到与当前解析相反的那个，给用户明确反馈
                    const modeNow = getSavedMode();
                    let next;
                    if (modeNow === 'auto') {
                        next = resolvedTheme('auto') === 'dark' ? 'light' : 'dark';
                    } else if (modeNow === 'light') {
                        next = 'dark';
                    } else {
                        next = 'light';
                    }
                    apply(next);
                    closePopover();
                });

                // 右键打开菜单
                btn.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (popover && popover.classList.contains('active')) closePopover();
                    else openPopoverNear(btn);
                });
            });

            // Popover interactions
            if (popover) {
                popover.addEventListener('click', (e) => {
                    const item = e.target.closest('.item');
                    if (!item) return;
                    mode = item.getAttribute('data-mode');
                    apply(mode);
                    closePopover();
                });
            }

            // Outside click / Esc to close
            document.addEventListener('click', (e) => {
                if (!popover) return;
                if (!popover.contains(e.target) && !toggles.some(b => b.contains(e.target))) {
                    closePopover();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closePopover();
            });

            // Follow system when mode is auto
            if (media && media.addEventListener) {
                media.addEventListener('change', () => { if (getSavedMode()==='auto') apply('auto'); });
            } else if (media && media.addListener) {
                media.addListener(() => { if (getSavedMode()==='auto') apply('auto'); });
            }
        })();

        // Large Title → Compact on scroll
        function applyCompactHeader() {
            if (!commandHubEl) return;
            if (window.scrollY > 6) commandHubEl.classList.add('compact');
            else commandHubEl.classList.remove('compact');
            updateFloatingState();

            if (isCommandHubFloating && !isCommandHubCollapsed && collapseOnScrollArmed) {
                const delta = Math.abs(window.scrollY - lastManualExpandScrollY);
                if (delta > 120) {
                    setCommandHubCollapsed(true, { force: true });
                }
            }
        }
        window.addEventListener('scroll', applyCompactHeader, { passive: true });
        window.addEventListener('resize', updateFloatingState, { passive: true });
        applyCompactHeader();

        // 设置当前年份
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>
