<!DOCTYPE html>
<!-- æ‰€æœ‰ UI è®¾è®¡å¿…é¡»ç¬¦åˆ Apple å®¡ç¾ï¼Œåšåˆ° Only Apple can do çš„æ•ˆæœã€‚ -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›½åº†ä½œä¸šè¿›åº¦</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: #f5f5f7;
            min-height: 100vh;
            padding: 40px 20px 40px;
            display: flex;
            justify-content: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 50px;
        }

        h1 {
            color: #1d1d1f;
            font-size: 2.5em;
            font-weight: 600;
            letter-spacing: -0.02em;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: #007aff;
            color: white;
        }

        .btn:hover {
            background: #0051d5;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #86868b;
        }

        .btn-secondary:hover {
            background: #6e6e73;
        }

        .subject-section {
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            position: relative;
            transition: box-shadow .24s cubic-bezier(0.4, 0, 0.2, 1), transform .24s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, box-shadow;
        }
        .subject-section:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }

        .subject-section.draggable-subject {
            cursor: move;
        }

        .subject-section.dragging-subject {
            opacity: 0.5;
        }

        .subject-section.drag-over-subject {
            border: 2px dashed #007aff;
        }

        .subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .subject-title {
            color: #1d1d1f;
            font-size: 1.3em;
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .subject-actions {
            display: none;
            gap: 8px;
        }

        .subject-section.edit-mode .subject-actions {
            display: flex;
        }

        .icon-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            background: #f5f5f7;
            color: #1d1d1f;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: #e5e5e7;
        }

        .icon-btn.delete {
            background: #ff3b30;
            color: white;
        }

        .icon-btn.delete:hover {
            background: #d32f2f;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 12px;
        }

        .card {
            padding: 20px;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .card.draggable {
            cursor: move;
        }

        .card.dragging {
            opacity: 0.5;
        }

        .card.drag-over {
            border: 2px dashed rgba(255, 255, 255, 0.5);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }

        .card.completed {
            background: #34c759;
        }

        .card.in-progress {
            background: #ff9500;
        }

        .card.not-started {
            background: #ff3b30;
        }

        .card.add-card {
            background: #f5f5f7;
            color: #007aff;
            display: none;
            justify-content: center;
            align-items: center;
            font-weight: 600;
            border: 2px dashed #007aff;
        }

        .edit-mode .card.add-card {
            display: flex;
        }

        .card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.3);
            color: white;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            line-height: 1;
        }

        .edit-mode .card-delete {
            display: flex;
        }

        .card-title {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }

        .card-status {
            font-size: 0.9em;
            opacity: 0.9;
            font-weight: 500;
        }

        /* progress controls */
        /* hover to reveal controls */
        .hover-controls { margin-top: 8px; opacity: 0; max-height: 0; overflow: hidden; pointer-events: none; transition: opacity .16s ease, max-height .16s ease; }
        .card:hover .hover-controls, .card:focus-within .hover-controls, .card.show-controls .hover-controls { opacity: 1; max-height: 200px; pointer-events: auto; }
        .pages-controls { margin-top: 8px; display: flex; align-items: center; gap: 8px; }
        .pages-controls .mini-input { transition: background-color .18s ease, transform .18s ease; }
        .pages-controls .mini-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(10,132,255,0.25); }
        .pages-controls .mini-input:active { transform: scale(0.99); }
        .mini-input { width: 72px; height: 28px; border-radius: 6px; border: 0; padding: 4px 6px; background: rgba(255,255,255,0.95); color: #1d1d1f; }
        .page-input { width: 80px; }
        .pages-controls .slash { opacity: 0.9; }
        [data-theme="dark"] .mini-input { background: rgba(255,255,255,0.9); color: #1d1d1f; }
        .sub-title { margin-top: 16px; font-size: 0.95em; color: #6e6e73; font-weight: 600; }
        [data-theme="dark"] .sub-title { color: #a1a1a6; }


        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            display: flex;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity .24s cubic-bezier(0.4,0,0.2,1), visibility 0s linear .24s;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity .24s cubic-bezier(0.4,0,0.2,1);
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(8px) scale(0.995);
            opacity: 0;
            transition: transform .28s cubic-bezier(0.22,0.61,0.36,1), opacity .2s ease;
        }
        .modal.active .modal-content { transform: none; opacity: 1; }

        .modal-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #1d1d1f;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #1d1d1f;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #007aff;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        .progress-section {
            background: white;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.12);
            overflow: hidden;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            max-width: 900px;
            margin: 0 auto;
        }

        .progress-header {
            padding: 20px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s;
        }

        .progress-header:hover {
            background: #fafafa;
        }

        .progress-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.01em;
        }

        .toggle-icon {
            font-size: 1.2em;
            color: #86868b;
            transition: transform 0.3s;
        }

        .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }

        .progress-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
            padding: 0 24px 24px;
        }

        .progress-content.collapsed {
            max-height: 0;
            padding: 0 24px;
        }

        /* åŠ¨æ€é¢„ç•™ç©ºéš™ï¼ˆä¸è¿›åº¦æ‚¬æµ®çª—è”åŠ¨ï¼‰ */
        #progressSpacer { height: 0; transition: height 0.3s ease; }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background: #e5e5e7;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #007aff;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-text {
            text-align: center;
            margin-top: 8px;
            font-size: 0.95em;
            color: #1d1d1f;
            font-weight: 600;
        }

        /* Subject mini progress */
        .subject-progress { display:flex; align-items:center; gap:10px; margin: -4px 0 12px; }
        .subject-progress .progress-bar-container { flex: 1; }
        .subject-progress-text { font-size: 0.95em; font-weight: 600; color: #1d1d1f; min-width: 44px; text-align: right; letter-spacing: -0.01em; }
        [data-theme='dark'] .subject-progress-text { color: #f5f5f7; }
        /* when any progress bar completes */
        .progress-bar.complete { background: #34c759; }
        [data-theme='dark'] .progress-bar.complete { background: #30d158; }

        .stats {
            display: grid;
            /* è‡ªé€‚åº”åˆ—æ•°ï¼šæ¯å—æœ€å° 160pxï¼Œæœ€å¤§å‡åˆ† */
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        .stat-item {
            padding: 12px;
            background: #f5f5f7;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: 600;
            color: #1d1d1f;
            letter-spacing: -0.02em;
        }

        .stat-label {
            color: #86868b;
            font-size: 0.85em;
            margin-top: 2px;
            font-weight: 500;
        }

        .float-btn {
            position: fixed;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            padding: 12px 20px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            color: #007aff;
            border: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            letter-spacing: -0.01em;
        }

        .float-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: translateY(-50%) scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .float-btn:active {
            transform: translateY(-50%) scale(0.98);
        }

        .float-btn-icon {
            font-size: 1.2em;
        }

        .help-btn {
            position: fixed;
            left: 30px;
            top: 30px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            color: #007aff;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .help-btn:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .help-btn:active {
            transform: scale(0.95);
        }

        .help-content {
            line-height: 1.6;
        }

        .help-content h3 {
            color: #1d1d1f;
            font-size: 1.1em;
            font-weight: 600;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .help-content h3:first-child {
            margin-top: 0;
        }

        .help-content p {
            color: #6e6e73;
            margin-bottom: 8px;
        }

        .help-content ul {
            list-style: none;
            padding-left: 0;
        }

        .help-content li {
            color: #6e6e73;
            margin-bottom: 8px;
            padding-left: 20px;
            position: relative;
        }

        .help-content li:before {
            content: "â€¢";
            position: absolute;
            left: 6px;
            color: #007aff;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 20px;
            }

            .header-buttons {
                width: 100%;
            }

            .btn {
                flex: 1;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .float-btn {
                right: 20px;
                padding: 10px 16px;
                font-size: 0.85em;
            }

            .float-btn-icon {
                font-size: 1em;
            }

            .help-btn {
                left: 20px;
                top: 20px;
                width: 32px;
                height: 32px;
                font-size: 1em;
            }
        }

        .footer {
            text-align: center;
            color: #86868b;
            font-size: 0.85em;
            font-weight: 400;
            letter-spacing: -0.01em;
            margin: 60px 0 40px;
            padding: 0 20px;
        }

        .footer-divider {
            margin: 0 8px;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .footer {
                font-size: 0.8em;
                margin: 40px 0 30px;
            }
        /* ä¸»é¢˜ï¼šåŸºç¡€ä¸æš—è‰²è¦†ç›– */
        :root { color-scheme: light; }
        [data-theme='dark'] { color-scheme: dark; }

        /* å³ä¸Šè§’èƒ¶å›ŠæŒ‰é’®ï¼ˆApple é£æ ¼ï¼‰ */
        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            background: #f5f5f7;
            color: #1d1d1f;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            flex: 0 0 auto;
        }
        .tool-btn:hover { background: #e5e5e7; transform: translateY(-1px); }

        /* æš—è‰²è¦†ç›–ï¼ˆè´´è¿‘ Apple ç³»ç»Ÿè‰²æ¿ï¼‰ */
        [data-theme='dark'] body { background: #000000; color: #f5f5f7; }
        [data-theme='dark'] h1,
        [data-theme='dark'] .subject-title,
        [data-theme='dark'] .modal-title,
        [data-theme='dark'] .form-label,
        [data-theme='dark'] .progress-title,
        [data-theme='dark'] .stat-number { color: #f5f5f7; }

        [data-theme='dark'] .subject-section,
        [data-theme='dark'] .modal-content,
        [data-theme='dark'] .progress-section { background: #1c1c1e; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }

        [data-theme='dark'] .icon-btn,
        [data-theme='dark'] .stat-item,
        [data-theme='dark'] .card.add-card { background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .icon-btn:hover { background: #3a3a3c; }

        [data-theme='dark'] .btn { background: #0a84ff; }
        [data-theme='dark'] .btn:hover { background: #0060df; }
        [data-theme='dark'] .btn-secondary { background: #636366; }
        [data-theme='dark'] .btn-secondary:hover { background: #525255; }

        [data-theme='dark'] .progress-header:hover { background: rgba(255,255,255,0.04); }
        [data-theme='dark'] .toggle-icon,
        [data-theme='dark'] .stat-label,
        [data-theme='dark'] .help-content p,
        [data-theme='dark'] .help-content li,
        [data-theme='dark'] .footer { color: #a1a1a6; }
        [data-theme='dark'] .help-content li:before { color: #0a84ff; }

        [data-theme='dark'] .progress-bar-container { background: #2c2c2e; }
        [data-theme='dark'] .progress-bar { background: #0a84ff; }

        [data-theme='dark'] .card.add-card { color: #0a84ff; border-color: #0a84ff; }

        [data-theme='dark'] .float-btn,
        [data-theme='dark'] .help-btn { background: rgba(28,28,30,0.72); color: #0a84ff; }
        [data-theme='dark'] .float-btn:hover,
        [data-theme='dark'] .help-btn:hover { background: rgba(28,28,30,0.85); }

        [data-theme='dark'] .form-input { border-color: #2c2c2e; background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .form-input:focus { border-color: #0a84ff; }

        [data-theme='dark'] .subject-section.drag-over-subject { border-color: #0a84ff; }
        [data-theme='dark'] .card-delete { background: rgba(255,255,255,0.2); }

        [data-theme='dark'] .tool-btn { background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .tool-btn:hover { background: #3a3a3c; }
        }
        /* ä¸»é¢˜ï¼šåŸºç¡€ä¸æš—è‰²è¦†ç›– */
        :root { color-scheme: light; }
        [data-theme='dark'] { color-scheme: dark; }

        /* å³ä¸Šè§’èƒ¶å›ŠæŒ‰é’®ï¼ˆApple é£æ ¼ï¼‰ */
        .tool-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 10px;
            background: #f5f5f7;
            color: #1d1d1f;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
            flex: 0 0 auto;
        }
        .tool-btn:hover { background: #e5e5e7; transform: translateY(-1px); }

        .tool-text-btn { width: auto; min-width: 36px; height: 36px; padding: 0 10px; font-weight: 600; }
        .tool-btn:active { transform: scale(0.98); }


        /* æš—è‰²è¦†ç›–ï¼ˆè´´è¿‘ Apple ç³»ç»Ÿè‰²æ¿ï¼‰ */
        [data-theme='dark'] body { background: #000000; color: #f5f5f7; }
        [data-theme='dark'] h1,
        [data-theme='dark'] .subject-title,
        [data-theme='dark'] .modal-title,
        [data-theme='dark'] .form-label,
        [data-theme='dark'] .progress-title,
        [data-theme='dark'] .stat-number { color: #f5f5f7; }

        [data-theme='dark'] .subject-section,
        [data-theme='dark'] .modal-content,
        [data-theme='dark'] .progress-section { background: #1c1c1e; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }

        [data-theme='dark'] .icon-btn,
        [data-theme='dark'] .stat-item,
        [data-theme='dark'] .card.add-card { background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .icon-btn:hover { background: #3a3a3c; }

        [data-theme='dark'] .btn { background: #0a84ff; }
        [data-theme='dark'] .btn:hover { background: #0060df; }
        [data-theme='dark'] .btn-secondary { background: #636366; }
        [data-theme='dark'] .btn-secondary:hover { background: #525255; }

        [data-theme='dark'] .progress-header:hover { background: rgba(255,255,255,0.04); }
        [data-theme='dark'] .toggle-icon,
        [data-theme='dark'] .stat-label,
        [data-theme='dark'] .help-content p,
        [data-theme='dark'] .help-content li,
        [data-theme='dark'] .footer { color: #a1a1a6; }
        [data-theme='dark'] .help-content li:before { color: #0a84ff; }

        [data-theme='dark'] .progress-bar-container { background: #2c2c2e; }
        [data-theme='dark'] .progress-bar { background: #0a84ff; }

        [data-theme='dark'] .card.add-card { color: #0a84ff; border-color: #0a84ff; }

        [data-theme='dark'] .float-btn,
        [data-theme='dark'] .help-btn { background: rgba(28,28,30,0.72); color: #0a84ff; }
        [data-theme='dark'] .float-btn:hover,
        [data-theme='dark'] .help-btn:hover { background: rgba(28,28,30,0.85); }

        [data-theme='dark'] .form-input { border-color: #2c2c2e; background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .form-input:focus { border-color: #0a84ff; }

        [data-theme='dark'] .subject-section.drag-over-subject { border-color: #0a84ff; }
        [data-theme='dark'] .card-delete { background: rgba(255,255,255,0.2); }

        [data-theme='dark'] .tool-btn { background: #2c2c2e; color: #f5f5f7; }
        [data-theme='dark'] .tool-btn:hover { background: #3a3a3c; }
    
        /* æ ‡é¢˜è¡Œä¸ç§»åŠ¨ç«¯ä½ç½®ä¼˜åŒ– */
        .title-row { display: flex; align-items: center; gap: 10px; }
        #themeToggleMobile { display: none; }
        @media (max-width: 768px) {
            #themeToggleMobile { display: inline-flex; }
            #themeToggle { display: none; }
        }

        /* ä¸‰æ®µæ¨¡å¼é€‰æ‹© Popover */
        .theme-popover {
            position: fixed;
            min-width: 180px;
            background: #ffffff;
            color: #1d1d1f;
            border-radius: 12px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.20);
            padding: 8px;
            z-index: 3000;
            border: 1px solid rgba(0,0,0,0.06);
            display: none;
            overflow: hidden; /* è®©å­é¡¹ hover èƒŒæ™¯åœ¨åœ†è§’å†…è£åˆ‡ */
            opacity: 0;
            transform: translateY(-6px) scale(0.98);
            transition: transform .22s cubic-bezier(0.22,0.61,0.36,1), opacity .18s ease;
        }
        .theme-popover.active { display: block; opacity: 1; transform: none; }
        .theme-popover .item {
            display: flex; align-items: center; gap: 10px;
            padding: 10px 12px; border-radius: 10px; cursor: pointer;
        }
        .theme-popover .item:hover { background: #f5f5f7; }
        .theme-popover .check { margin-left: auto; opacity: 0.8; visibility: hidden; }
        .theme-popover .item.active .check { visibility: visible; }
        [data-theme='dark'] .theme-popover { background: #1c1c1e; color:#f5f5f7; border-color: rgba(255,255,255,0.08); box-shadow: 0 16px 44px rgba(0,0,0,0.6); }
        [data-theme='dark'] .theme-popover .item:hover { background: #2c2c2e; }

        /* ç¡®ä¿æš—è‰²ä¸‹å¼¹çª—ä»ä¿ç•™åœ†è§’ï¼ˆé˜²æ­¢è¦†ç›–ä¸¢å¤±ï¼‰ */
        [data-theme='dark'] .modal-content { border-radius: 16px; }

        /* æš—è‰²ä¸‹çš„çŠ¶æ€è‰²å¾®è°ƒï¼ˆApple é£æ ¼ï¼‰ */
        [data-theme='dark'] .card.completed { background: #30d158; }
        [data-theme='dark'] .card.in-progress { background: #ff9f0a; }
        [data-theme='dark'] .card.not-started { background: #ff453a; }

    
        /* Apple-quality: mobile gear toggle, edit-mode expansion, pages stat mini bar */
        .card-gear {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; border-radius: 50%;
            background: rgba(0,0,0,0.28); color: #fff; border: none; cursor: pointer;
            display: none; align-items: center; justify-content: center; font-size: 14px; line-height: 1;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            backdrop-filter: saturate(180%) blur(16px); -webkit-backdrop-filter: saturate(180%) blur(16px);
        }
        .card-gear:hover { background: rgba(0,0,0,0.36); }
        .card-gear:active { transform: scale(0.94); opacity: 0.9; }
        .edit-mode .card-gear { right: 36px; }
        @media (hover: none) and (pointer: coarse) { .card-gear { display: flex; } }
        .card.show-controls .hover-controls { opacity: 1; max-height: 200px; pointer-events: auto; }
        .subject-section.edit-mode .hover-controls { opacity: 1; max-height: 200px; pointer-events: auto; }
        #pagesStat .stat-progress { width: 100%; height: 4px; background: #e5e5e7; border-radius: 2px; overflow: hidden; margin-top: 6px; }
        #pagesStat .stat-progress .bar { height: 100%; background: #007aff; width: 0%; transition: width 0.4s cubic-bezier(0.4,0,0.2,1); }
        [data-theme='dark'] #pagesStat .stat-progress { background: #2c2c2e; }
        [data-theme='dark'] #pagesStat .stat-progress .bar { background: #0a84ff; }
        .card-delete, .card-gear { z-index: 2; }

    
        /* å¸®åŠ©å¼¹çª—ï¼šæ‚¬æµ®â€œæˆ‘çŸ¥é“äº†â€æŒ‰é’®ï¼ˆApple é£æ ¼ï¼‰ */
            position: fixed;
            right: 30px;
            bottom: 30px;
            z-index: 3500;
            padding: 12px 18px;
            border-radius: 20px;
            border: none;
            background: rgba(255, 255, 255, 0.88);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
            color: #007aff;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            letter-spacing: -0.01em;
            display: none; /* ä»…åœ¨å¸®åŠ©å¼¹çª—å¼€å¯æ—¶æ˜¾ç¤º */
        }

            /* Apple-style Header Toolbar */
        .header-buttons { gap: 12px; display: flex; align-items: center; }
        .toolbar { display: inline-flex; align-items: center; gap: 4px; padding: 4px; border-radius: 12px; background: rgba(255,255,255,0.72); backdrop-filter: saturate(180%) blur(20px); -webkit-backdrop-filter: saturate(180%) blur(20px); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .toolbar .divider { width: 1px; height: 24px; background: linear-gradient(to bottom, transparent, rgba(0,0,0,0.18), transparent); margin: 0 2px; }
        .toolbar-btn { appearance: none; -webkit-appearance: none; border: 0; cursor: pointer; background: transparent; color: #1d1d1f; border-radius: 8px; font-size: 0.9em; font-weight: 600; letter-spacing: -0.01em; padding: 6px 12px; min-height: 32px; transition: background 0.2s, transform 0.2s; }
        .toolbar-btn:hover { background: rgba(0,0,0,0.06); }
        .toolbar-btn:active { transform: scale(0.98); }
        .toolbar-btn.primary { background: #007aff; color: #fff; }
        .toolbar-btn.primary:hover { background: #0060df; }
        [data-theme=dark] .toolbar { background: rgba(28,28,30,0.72); border-color: rgba(255,255,255,0.08); box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        [data-theme=dark] .toolbar .divider { background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.24), transparent); }
        [data-theme=dark] .toolbar-btn { color: #f5f5f7; }
        [data-theme=dark] .toolbar-btn:hover { background: rgba(255,255,255,0.08); }
        [data-theme=dark] .toolbar-btn.primary { background: #0a84ff; }
        [data-theme=dark] .toolbar-btn.primary:hover { background: #0060df; }
        .toolbar-btn:disabled, .toolbar-btn[aria-disabled="true"] { opacity: 0.5; cursor: default; transform: none; }
        .toolbar-btn:disabled:hover, .toolbar-btn[aria-disabled="true"]:hover { background: transparent; }

        .toolbar-btn:focus-visible, .tool-btn:focus-visible { outline: 2px solid #0a84ff; outline-offset: 2px; }


        /* Toolbar responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; align-items: flex-start; gap: 12px; }
            .header-buttons { width: 100%; justify-content: flex-start; flex-wrap: wrap; gap: 8px; }
            .toolbar { width: auto; flex-wrap: wrap; }
            .toolbar .divider { display: none; }
        }

    
        /* Toolbar button variants */
        .toolbar-btn.outline { border: 1px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.6); color: #007aff; }
        .toolbar-btn.outline:hover { background: rgba(0,0,0,0.06); }
        [data-theme='dark'] .toolbar-btn.outline { border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.08); color: #0a84ff; }
        [data-theme='dark'] .toolbar-btn.outline:hover { background: rgba(255,255,255,0.12); }

        /* Large Title â†’ Compact on scroll */
        .header { transition: padding 0.25s ease, background 0.25s ease; }
        .header h1 { transition: font-size 0.25s ease, letter-spacing 0.25s ease; }
        .header.compact h1 { font-size: 1.6em; letter-spacing: -0.01em; }

        /* Help modal scroll area uses inner scroll to preserve rounded corners */
        #helpModal .modal-content { overflow: hidden; display: flex; flex-direction: column; }
        #helpModal .help-content { max-height: 60vh; overflow: auto; padding-right: 6px; }
        #helpModal .help-content::-webkit-scrollbar { width: 8px; }
        #helpModal .help-content::-webkit-scrollbar-track { background: transparent; }
        #helpModal .help-content::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 8px; }
        [data-theme='dark'] #helpModal .help-content::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.25); }
        #helpModal .help-content { scrollbar-color: rgba(0,0,0,0.2) transparent; scrollbar-width: thin; }


        @media (prefers-reduced-motion: reduce) { * { animation-duration: 0.01ms !important; animation-iteration-count: 1 !important; transition-duration: 0.01ms !important; scroll-behavior: auto !important; } }

        @media (max-width: 768px) { .tool-btn { height: 44px; min-width: 44px; } .tool-text-btn { min-width: 44px; padding: 0 12px; } }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title-row">
                <button class="tool-btn theme-toggle" id="themeToggleMobile" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
                <h1>å›½åº†ä½œä¸šå®Œæˆè¿›åº¦</h1>
            </div>
            <div class="header-buttons">
                <div class="toolbar">
                    <button class="toolbar-btn" onclick="importConfig()" aria-label="å¯¼å…¥é…ç½®">å¯¼å…¥</button>
                    <button class="toolbar-btn" onclick="exportConfig()" aria-label="å¯¼å‡ºé…ç½®">å¯¼å‡º</button>
                    <button class="toolbar-btn" id="saveImageBtn" onclick="saveAsImage()" aria-label="ä¿å­˜å›¾ç‰‡">ä¿å­˜</button>
                    <span class="divider"></span>
                    <button class="toolbar-btn outline" id="editBtn" onclick="toggleEdit()">ç¼–è¾‘</button>
                </div>
                <div class="toolbar">
                    <button class="toolbar-btn" id="helpBtn" onclick="openModal('helpModal')" aria-label="ä½¿ç”¨è¯´æ˜" title="ä½¿ç”¨è¯´æ˜">ä½¿ç”¨è¯´æ˜</button>
                    <span class="divider"></span>
                    <button class="toolbar-btn theme-toggle" id="themeToggle" aria-label="åˆ‡æ¢ä¸»é¢˜" title="åˆ‡æ¢ä¸»é¢˜">åˆ‡æ¢ä¸»é¢˜</button>
                </div>
            </div>
        </div>

        <div id="subjectsContainer"></div>

        <div class="footer">
            <span>Designed & Built by WitMarx</span>
            <span class="footer-divider">â€¢</span>
            <span>Â© <span id="currentYear"></span></span>
        </div>

        <!-- åŠ¨æ€é¢„ç•™åº•éƒ¨ç©ºé—´ï¼ˆç”¨äºè¿›åº¦æ‚¬æµ®çª—å±•å¼€æ—¶é¿å…é®æŒ¡ï¼‰ -->
        <div id="progressSpacer" aria-hidden="true"></div>

        <div class="progress-section">
            <div class="progress-header" onclick="toggleProgress()">
                <div class="progress-title">æ€»ä½“å®Œæˆè¿›åº¦</div>
                <div class="toggle-icon" id="toggleIcon">â–¼</div>
            </div>
            <div class="progress-content" id="progressContent">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-text" id="progressText">0%</div>
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number" id="completedCount">0</div>
                        <div class="stat-label">å·²å®Œæˆ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="inProgressCount">0</div>
                        <div class="stat-label">è¿›è¡Œä¸­</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="notStartedCount">0</div>
                        <div class="stat-label">æœªå®Œæˆ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="totalCount">0</div>
                        <div class="stat-label">æ€»è®¡</div>
                    </div>
                    <div class="stat-item" id="pagesStat">
                        <div class="stat-number" id="pagesPercent">0%</div>
                        <div class="stat-progress"><div class="bar" id="pagesBar"></div></div>
                        <div class="stat-label" id="pagesLabel">é¡µæ•° 0/0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- ä½¿ç”¨è¯´æ˜å¼¹çª— -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <div class="modal-title">ä½¿ç”¨è¯´æ˜</div>
            <div class="help-content">
                <h3>ğŸ§­ å¿«é€Ÿä¸Šæ‰‹</h3>
                <ul>
                    <li>ç‚¹å¡ç‰‡åˆ‡æ¢çŠ¶æ€ï¼šæœªå®Œæˆ â†’ è¿›è¡Œä¸­ â†’ å·²å®Œæˆ</li>
                    <li>è¿›è¡Œä¸­ä»»åŠ¡å¯ç”¨æ»‘å—æˆ–ç™¾åˆ†æ¯”è¾“å…¥ï¼ˆè§¦å±ç‚¹é½¿è½®å±•å¼€æ§ä»¶ï¼‰</li>
                    <li>å¯å½•å…¥â€œå·²é¡µ/æ€»é¡µâ€ï¼Œè‡ªåŠ¨æŒ‰é¡µæ•°è®¡ç®—å®Œæˆåº¦ï¼›ä»…å¡«â€œæ€»é¡µâ€ä¹Ÿå¯å‚ä¸æ±‡æ€»</li>
                </ul>
                <h3>âœï¸ ç¼–è¾‘ä¸æ’åº</h3>
                <ul>
                    <li>ç‚¹å³ä¸Šâ€œç¼–è¾‘â€è¿›å…¥ç¼–è¾‘æ¨¡å¼ï¼šå¯å¢åˆ å­¦ç§‘/ä½œä¸šï¼Œæ”¯æŒæ‹–æ‹½æ’åº</li>
                    <li>ç¼–è¾‘æ¨¡å¼ä¸‹æ§ä»¶é»˜è®¤å±•å¼€ï¼Œä¾¿äºæ‰¹é‡å½•å…¥é¡µæ•°</li>
                </ul>
                <h3>ğŸ“Š æ±‡æ€»ä¸ç»Ÿè®¡</h3>
                <ul>
                    <li>åº•éƒ¨æ˜¾ç¤ºæ€»ä½“å®Œæˆåº¦ï¼›å±•å¼€å¯æŸ¥çœ‹ä»»åŠ¡ç»Ÿè®¡ä¸â€œé¡µæ•°â€æ±‡æ€»</li>
                    <li>â€œé¡µæ•°â€å¡ç‰‡å¸¦ç»†è¿›åº¦æ¡ï¼Œå±•ç¤ºå·²å®Œæˆé¡µ/æ€»é¡µ</li>
                </ul>
                <h3>ğŸ’¾ é…ç½®ä¸åˆ†äº«</h3>
                <ul>
                    <li>å¯¼å‡º/å¯¼å…¥é…ç½®ï¼šå¤‡ä»½æˆ–åœ¨è®¾å¤‡é—´åŒæ­¥è¿›åº¦</li>
                    <li>å³ä¸Šâ€œä¿å­˜å›¾ç‰‡â€å°†é¡µé¢ä¿å­˜ä¸º PNGï¼Œä¾¿äºåˆ†äº«/æ‰“å°</li>
                </ul>
            </div>
            <div class="modal-buttons">
                <button class="btn" onclick="closeModal('helpModal')">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ å­¦ç§‘å¼¹çª— -->
    <div class="modal" id="addSubjectModal">
        <div class="modal-content">
            <div class="modal-title">æ·»åŠ å­¦ç§‘</div>
            <div class="form-group">
                <label class="form-label">å­¦ç§‘åç§°</label>
                <input type="text" class="form-input" id="subjectTitle">
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('addSubjectModal')">å–æ¶ˆ</button>
                <button class="btn" onclick="confirmAddSubject()">ç¡®å®š</button>
            </div>
        </div>
    

    <div class="theme-popover" id="themePopover" role="menu" aria-hidden="true">
        <div class="item" data-mode="auto"><span>è·Ÿéšç³»ç»Ÿ</span><span class="check">âœ“</span></div>
        <div class="item" data-mode="light"><span>æµ…è‰²</span><span class="check">âœ“</span></div>
        <div class="item" data-mode="dark"><span>æ·±è‰²</span><span class="check">âœ“</span></div>
    </div>
</div>

    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="handleFileImport(event)">

    <script src="default-config.js"></script>
    <script>
        let editMode = false;
        let currentSubjectIndex = -1;
        function cloneSubjectsConfig(config) {
            if (!Array.isArray(config)) return [];
            return config.map(subject => ({
                name: subject?.name || 'æœªå‘½åå­¦ç§‘',
                homeworks: Array.isArray(subject?.homeworks)
                    ? subject.homeworks.map(hw => ({
                        title: hw?.title || 'æœªå‘½åä½œä¸š',
                        status: hw?.status || 'not-started',
                        pagesDone: hw?.pagesDone,
                        pagesTotal: hw?.pagesTotal
                    }))
                    : []
            }));
        }

        const STORAGE_KEY = 'homeworkSubjectsConfig';

        function loadInitialSubjects() {
            if (typeof window !== 'undefined' && window.localStorage) {
                try {
                    const stored = window.localStorage.getItem(STORAGE_KEY);
                    if (stored) {
                        const parsed = JSON.parse(stored);
                        if (Array.isArray(parsed)) {
                            return cloneSubjectsConfig(parsed);
                        }
                    }
                } catch (error) {
                    console.warn('è¯»å–æœ¬åœ°é…ç½®å¤±è´¥ï¼š', error);
                }
            }
            return cloneSubjectsConfig(window.defaultSubjects);
        }

        function persistSubjects() {
            if (typeof window === 'undefined' || !window.localStorage) return;
            try {
                window.localStorage.setItem(STORAGE_KEY, JSON.stringify(subjects));
            } catch (error) {
                console.warn('ä¿å­˜æœ¬åœ°é…ç½®å¤±è´¥ï¼š', error);
            }
        }

        function resetSubjectsToDefault() {
            subjects = cloneSubjectsConfig(window.defaultSubjects);
            renderSubjects();
        }

        window.resetSubjectsToDefault = resetSubjectsToDefault;

        let subjects = loadInitialSubjects();

        function renderSubjects() {
            const container = document.getElementById('subjectsContainer');
            container.innerHTML = '';

            subjects.forEach((subject, subjectIndex) => {
                const section = document.createElement('div');
                section.className = 'subject-section' + (editMode ? ' edit-mode draggable-subject' : '');
                section.draggable = editMode;
                section.dataset.subjectIndex = subjectIndex;

                const subjectPercent = getSubjectProgressPercent(subject);
                section.innerHTML = `
                    <div class="subject-header">
                        <h2 class="subject-title">${subject.name}</h2>
                        <div class="subject-actions">
                            <button class="icon-btn" onclick="addHomework(${subjectIndex})">+ ä½œä¸š</button>
                            <button class="icon-btn delete" onclick="deleteSubject(${subjectIndex})">åˆ é™¤å­¦ç§‘</button>
                        </div>
                    </div>
                    <div class="subject-progress">
                      <div class="progress-bar-container">
                        <div class="progress-bar subject-progress-bar ${subjectPercent === 100 ? 'complete' : ''}" data-subject-index="${subjectIndex}" style="width:${subjectPercent}%"></div>
                      </div>
                      <div class="subject-progress-text" data-subject-index="${subjectIndex}">${subjectPercent}%</div>
                    </div>
                    <div class="cards-grid" data-subject-index="${subjectIndex}">
                        ${subject.homeworks.map((hw, hwIndex) => `
                            <div class="card ${hw.status} ${editMode ? 'draggable' : ''}"
                                 draggable="${editMode}"
                                 data-subject-index="${subjectIndex}"
                                 data-hw-index="${hwIndex}"
                                 onclick="toggleStatus(${subjectIndex}, ${hwIndex})">
                                <button class="card-delete" onclick="event.stopPropagation(); deleteHomework(${subjectIndex}, ${hwIndex})">Ã—</button>
                                <button class="card-gear" onclick="event.stopPropagation(); toggleCardControls(this)" aria-label="å±•å¼€æ§ä»¶" title="å±•å¼€æ§ä»¶">âš™ï¸</button>
                                <div class="card-title">${hw.title}</div>
                                                                <div class="card-status">${getStatusText(hw)}</div>
                                <div class="hover-controls" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">
                                  <div class="pages-controls" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()">
                                    <input type="number" class="mini-input page-input" min="0" placeholder="å·²é¡µ"
                                           value="${(hw.pagesDone != null ? hw.pagesDone : "")}"
                                           oninput="updateHwPages(${subjectIndex}, ${hwIndex}, 'done', this.value)">
                                    <span class="slash">/</span>
                                    <input type="number" class="mini-input page-input" min="0" placeholder="æ€»é¡µ"
                                           value="${(hw.pagesTotal != null ? hw.pagesTotal : "")}"
                                           oninput="updateHwPages(${subjectIndex}, ${hwIndex}, 'total', this.value)">
                                  </div>
                                </div>

                            </div>
                        `).join('')}
                        <div class="card add-card" onclick="addHomework(${subjectIndex})">
                            + æ·»åŠ ä½œä¸š
                        </div>
                    </div>
                `;

                container.appendChild(section);
            });

            if (editMode) {
                const addSection = document.createElement('div');
                addSection.className = 'subject-section';
                addSection.innerHTML = `
                    <button class="btn" style="width: 100%;" onclick="openAddSubjectModal()">+ æ·»åŠ å­¦ç§‘</button>
                `;
                container.appendChild(addSection);
            }

            updateProgress();
            setupDragAndDrop();
            setupSubjectDragAndDrop();
            persistSubjects();
        }

                // è¿›åº¦è®¡ç®—ï¼šæœ€è¿‘ä¸€æ¬¡ç¼–è¾‘ä¼˜å…ˆï¼ˆpages æˆ– manualï¼‰ï¼Œç¼ºçœæ—¶æŒ‰çŠ¶æ€å…œåº•
        function clampPercent(n) { return Math.max(0, Math.min(100, Math.round(Number(n) || 0))); }

        function getHomeworkProgress(hw) {
            if (!hw || !hw.status) return 0;
            if (hw.status === "completed") return 100;
            const pd = Number(hw.pagesDone), pt = Number(hw.pagesTotal);
            const pagesReady = Number.isFinite(pd) && Number.isFinite(pt) && pt > 0;
            if (pagesReady) return clampPercent(pd / pt * 100);
            return 0;
        }

        function getSubjectProgressPercent(subject) {
            if (!subject || !Array.isArray(subject.homeworks) || subject.homeworks.length === 0) return 0;
            let pagesDoneSum = 0;
            let pagesTotalSum = 0;
            subject.homeworks.forEach(hw => {
                const pt = Number(hw.pagesTotal);
                if (Number.isFinite(pt) && pt > 0) {
                    let pd = Number(hw.pagesDone);
                    if (!Number.isFinite(pd)) pd = (hw.status === "completed") ? pt : 0;
                    pagesDoneSum += Math.min(pd, pt);
                    pagesTotalSum += pt;
                }
            });
            return pagesTotalSum > 0 ? Math.round((pagesDoneSum / pagesTotalSum) * 100) : 0;
        }

        function getStatusText(hw) {
            if (!hw) return "æœªå®Œæˆ";
            if (hw.status === "completed") return "å·²å®Œæˆ";
            if (hw.status === "not-started") return "æœªå®Œæˆ";
            return "è¿›è¡Œä¸­ " + getHomeworkProgress(hw) + "%";
        }
        function syncStatusWithPages(hw) {
            const pt = Number(hw.pagesTotal);
            const pd = Number(hw.pagesDone);
            const hasPT = Number.isFinite(pt) && pt > 0;
            if (!hasPT) return;
            if (!Number.isFinite(pd) || pd <= 0) hw.status = 'not-started';
            else if (pd >= pt) hw.status = 'completed';
            else hw.status = 'in-progress';
        }

        function updateHwPages(subjectIndex, hwIndex, which, value) {
            const hw = subjects[subjectIndex].homeworks[hwIndex];
            const card = document.querySelector(`.card[data-subject-index="${subjectIndex}"][data-hw-index="${hwIndex}"]`);
            if (value === '' || value == null) {
                if (which === 'done') delete hw.pagesDone;
                if (which === 'total') delete hw.pagesTotal;
                syncStatusWithPages(hw);
                if (card) {
                    const sel = which === 'done' ? '.pages-controls input[placeholder="å·²é¡µ"]' : '.pages-controls input[placeholder="æ€»é¡µ"]';
                    const inp = card.querySelector(sel);
                    if (inp) inp.value = '';
                    const p = getHomeworkProgress(hw);
                    const statusEl = card.querySelector('.card-status');
                    if (statusEl) statusEl.textContent = getStatusText(hw);
                    card.classList.remove('not-started','in-progress','completed');
                    card.classList.add(hw.status);
                }
                updateProgress();
                return;
            }
            const v = Math.max(0, Math.floor(Number(value) || 0));
            if (which === "done") hw.pagesDone = v;
            if (which === "total") hw.pagesTotal = v;
            syncStatusWithPages(hw);
            if (card) {
                const doneInput = card.querySelector('.pages-controls input[placeholder="å·²é¡µ"]');
                const totalInput = card.querySelector('.pages-controls input[placeholder="æ€»é¡µ"]');
                if (doneInput && which === "done") doneInput.value = String(v);
                if (totalInput && which === "total") totalInput.value = String(v);
                const statusEl = card.querySelector('.card-status');
                    const p = getHomeworkProgress(hw);
                if (statusEl) statusEl.textContent = getStatusText(hw);
                card.classList.remove('not-started','in-progress','completed');
                card.classList.add(hw.status);
            }
            updateProgress();
        }

        function toggleCardControls(btn) {
            const card = btn.closest('.card');
            if (!card) return;
            card.classList.toggle('show-controls');
        }

        function toggleEdit() {
            editMode = !editMode;
            const btn = document.getElementById('editBtn');
            btn.textContent = editMode ? 'å®Œæˆ' : 'ç¼–è¾‘';
            if (btn) { btn.classList.remove('primary','outline'); btn.classList.add(editMode ? 'primary' : 'outline'); }
            renderSubjects();
        }

        function toggleStatus(subjectIndex, hwIndex) {
            if (editMode) return;

            const homework = subjects[subjectIndex].homeworks[hwIndex];
            const statusCycle = ['not-started', 'in-progress', 'completed'];
            const currentIndex = statusCycle.indexOf(homework.status);
            homework.status = statusCycle[(currentIndex + 1) % statusCycle.length];

            const pt = Number(homework.pagesTotal);
            if (Number.isFinite(pt) && pt > 0) {
                if (homework.status === 'completed') homework.pagesDone = pt;
                else if (homework.status === 'not-started') homework.pagesDone = 0;
            }

            renderSubjects();
        }

        function addHomework(subjectIndex) {
            currentSubjectIndex = subjectIndex;
            openModal('addHomeworkModal');
        }

        function confirmAddHomework() {
            const title = document.getElementById('homeworkTitle').value.trim();
            const status = document.getElementById('homeworkStatus').value;

            if (!title) {
                alert('è¯·è¾“å…¥ä½œä¸šåç§°');
                return;
            }

            subjects[currentSubjectIndex].homeworks.push({ title, status });
            document.getElementById('homeworkTitle').value = '';
            closeModal('addHomeworkModal');
            renderSubjects();
        }

        function deleteHomework(subjectIndex, hwIndex) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™é¡¹ä½œä¸šå—ï¼Ÿ')) {
                subjects[subjectIndex].homeworks.splice(hwIndex, 1);
                renderSubjects();
            }
        }

        function openAddSubjectModal() {
            openModal('addSubjectModal');
        }

        function confirmAddSubject() {
            const name = document.getElementById('subjectTitle').value.trim();

            if (!name) {
                alert('è¯·è¾“å…¥å­¦ç§‘åç§°');
                return;
            }

            subjects.push({ name, homeworks: [] });
            document.getElementById('subjectTitle').value = '';
            closeModal('addSubjectModal');
            renderSubjects();
        }

        function deleteSubject(subjectIndex) {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ•´ä¸ªå­¦ç§‘å—ï¼Ÿ')) {
                subjects.splice(subjectIndex, 1);
                renderSubjects();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function exportConfig() {
            const config = {
                version: "1.1",
                exportDate: new Date().toISOString(),
                subjects: subjects
            };

            const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å›½åº†ä½œä¸šé…ç½®_${new Date().toLocaleDateString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importConfig() {
            document.getElementById('fileInput').click();
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const config = JSON.parse(e.target.result);
                    if (config.subjects && Array.isArray(config.subjects)) {
                        if (confirm('å¯¼å…¥é…ç½®å°†æ›¿æ¢å½“å‰æ‰€æœ‰æ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                            subjects = cloneSubjectsConfig(config.subjects);
                            renderSubjects();
                        }
                    } else {
                        alert('é…ç½®æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®');
                    }
                } catch (error) {
                    alert('è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥ï¼š' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
        }

        function updateProgress() {
            let totalTasks = 0;
            let completed = 0;
            let inProgress = 0;
            let notStarted = 0;
            let sumProgress = 0;
            let pagesDoneSum = 0;
            let pagesTotalSum = 0;

            subjects.forEach(subject => {
                subject.homeworks.forEach(hw => {
                    totalTasks++;
                    if (hw.status === "completed") completed++;
                    else if (hw.status === "in-progress") inProgress++;
                    else if (hw.status === "not-started") notStarted++;

                    const p = getHomeworkProgress(hw);
                    sumProgress += p;

                    const pt = Number(hw.pagesTotal);
                    if (Number.isFinite(pt) && pt > 0) {
                        let pd = Number(hw.pagesDone);
                        if (!Number.isFinite(pd)) pd = (hw.status === "completed") ? pt : 0;
                        pagesDoneSum += Math.min(pd, pt);
                        pagesTotalSum += pt;
                    }
                });
            });

            const overall = totalTasks > 0 ? Math.round(sumProgress / totalTasks) : 0;
            const overallBar = document.getElementById('progressBar');
            if (overallBar) {
                overallBar.style.width = overall + "%";
                overallBar.classList.toggle('complete', overall === 100);
            }
            document.getElementById('progressText').textContent = overall + "%";
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('notStartedCount').textContent = notStarted;
            document.getElementById('totalCount').textContent = totalTasks;

            const pagesPct = pagesTotalSum > 0 ? Math.round((pagesDoneSum / pagesTotalSum) * 100) : 0;
            const pPctEl = document.getElementById('pagesPercent');
            const pLblEl = document.getElementById('pagesLabel');
            if (pPctEl) pPctEl.textContent = pagesPct + "%";
            if (pLblEl) pLblEl.textContent = `é¡µæ•° ${pagesDoneSum}/${pagesTotalSum}`;
            const pBarEl = document.getElementById('pagesBar');
            if (pBarEl) pBarEl.style.width = pagesPct + "%";
            if (typeof updateSubjectProgressBars === 'function') updateSubjectProgressBars();
            // æ ¹æ®è¿›åº¦é¢æ¿çŠ¶æ€æ›´æ–°åº•éƒ¨ä¿ç•™ç©ºé—´
            if (typeof updateProgressSpacer === 'function') updateProgressSpacer();
        }

        function updateSubjectProgressBars() {
            subjects.forEach((subject, idx) => {
                const pct = getSubjectProgressPercent(subject);
                const bar = document.querySelector(`.subject-progress-bar[data-subject-index="${idx}"]`);
                const lbl = document.querySelector(`.subject-progress-text[data-subject-index="${idx}"]`);
                if (bar) { bar.style.width = pct + '%'; bar.classList.toggle('complete', pct === 100); }
                if (lbl) lbl.textContent = pct + '%';
            });
        }

        function toggleProgress() {
            const content = document.getElementById('progressContent');
            const icon = document.getElementById('toggleIcon');
            content.classList.toggle('collapsed');
            icon.classList.toggle('collapsed');
            if (typeof updateProgressSpacer === 'function') updateProgressSpacer();
        }

        // ä¸è¿›åº¦æ‚¬æµ®çª—è”åŠ¨çš„åº•éƒ¨ç©ºéš™ç®¡ç†ï¼Œé¿å…æ”¶èµ·æ—¶ç”»é¢æŠ–åŠ¨
        function updateProgressSpacer() {
            const spacer = document.getElementById('progressSpacer');
            const section = document.querySelector('.progress-section');
            const content = document.getElementById('progressContent');
            const header = section ? section.querySelector('.progress-header') : null;
            if (!spacer || !section || !content || !header) return;
            const collapsed = content.classList.contains('collapsed');
            // å±•å¼€æ—¶é¢„ç•™â€œæ ‡é¢˜+å†…å®¹â€çš„é«˜åº¦ï¼›æ”¶èµ·æ—¶ä¸º 0
            const headerH = header.offsetHeight || 0;
            const contentH = collapsed ? 0 : content.scrollHeight;
            const target = collapsed ? 0 : (headerH + contentH);
            spacer.style.height = target + 'px';
        }

        function setupDragAndDrop() {
            if (!editMode) return;

            const draggableCards = document.querySelectorAll('.card.draggable');

            draggableCards.forEach(card => {
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragleave', handleDragLeave);
            });
        }

        let draggedElement = null;
        let draggedSubjectIndex = null;
        let draggedHwIndex = null;

        function handleDragStart(e) {
            draggedElement = this;
            draggedSubjectIndex = parseInt(this.dataset.subjectIndex);
            draggedHwIndex = parseInt(this.dataset.hwIndex);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('drag-over');
            });
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetCard = e.target.closest('.card.draggable');
            if (targetCard && targetCard !== draggedElement) {
                targetCard.classList.add('drag-over');
            }

            return false;
        }

        function handleDragLeave(e) {
            const targetCard = e.target.closest('.card.draggable');
            if (targetCard) {
                targetCard.classList.remove('drag-over');
            }
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetCard = e.target.closest('.card.draggable');
            if (!targetCard || targetCard === draggedElement) {
                return false;
            }

            const targetSubjectIndex = parseInt(targetCard.dataset.subjectIndex);
            const targetHwIndex = parseInt(targetCard.dataset.hwIndex);

            if (draggedSubjectIndex === targetSubjectIndex) {
                const subject = subjects[draggedSubjectIndex];
                const draggedHomework = subject.homeworks[draggedHwIndex];

                subject.homeworks.splice(draggedHwIndex, 1);
                subject.homeworks.splice(targetHwIndex, 0, draggedHomework);

                renderSubjects();
            }

            return false;
        }

        async function saveAsImage() {
            const button = document.getElementById('saveImageBtn');
            let originalText = '';
            if (button) {
                button.disabled = true;
                originalText = button.textContent;
                button.textContent = 'å¤„ç†ä¸­...';
            }
            try {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                document.head.appendChild(script);
                await new Promise((resolve, reject) => { script.onload = resolve; script.onerror = reject; });

                const progressSection = document.querySelector('.progress-section');
                const helpBtn = document.getElementById('helpBtn');
                const saveBtn = document.getElementById('saveImageBtn');

                const prevPos = progressSection && progressSection.style.position;
                const prevBottom = progressSection && progressSection.style.bottom;
                if (progressSection) { progressSection.style.position = 'relative'; progressSection.style.bottom = 'auto'; }
                if (helpBtn) helpBtn.style.display = 'none';
                if (saveBtn) saveBtn.style.display = 'none';

                const bg = getComputedStyle(document.body).backgroundColor;
                const canvas = await html2canvas(document.body, { backgroundColor: bg, scale: 2, logging: false, useCORS: true });

                if (progressSection) { progressSection.style.position = prevPos || 'fixed'; progressSection.style.bottom = prevBottom || '0'; }
                if (helpBtn) helpBtn.style.display = ''; 
                if (saveBtn) saveBtn.style.display = '';

                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `å›½åº†ä½œä¸šè¿›åº¦_${new Date().toLocaleDateString()}.png`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    if (button) { button.disabled = false; button.textContent = originalText || 'ä¿å­˜å›¾ç‰‡'; }
                });
            } catch (error) {
                alert('ä¿å­˜å›¾ç‰‡å¤±è´¥ï¼š' + error.message);
                if (button) { button.disabled = false; button.textContent = originalText || 'ä¿å­˜å›¾ç‰‡'; }
            }
        }

        function setupSubjectDragAndDrop() {
            if (!editMode) return;

            const draggableSections = document.querySelectorAll('.subject-section.draggable-subject');

            draggableSections.forEach(section => {
                section.addEventListener('dragstart', handleSubjectDragStart);
                section.addEventListener('dragend', handleSubjectDragEnd);
                section.addEventListener('dragover', handleSubjectDragOver);
                section.addEventListener('drop', handleSubjectDrop);
                section.addEventListener('dragleave', handleSubjectDragLeave);
            });
        }

        let draggedSubject = null;
        let draggedSubjectIdx = null;

        function handleSubjectDragStart(e) {
            if (e.target.classList.contains('card')) return;

            draggedSubject = this;
            draggedSubjectIdx = parseInt(this.dataset.subjectIndex);
            this.classList.add('dragging-subject');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleSubjectDragEnd(e) {
            this.classList.remove('dragging-subject');
            document.querySelectorAll('.subject-section').forEach(section => {
                section.classList.remove('drag-over-subject');
            });
        }

        function handleSubjectDragOver(e) {
            if (!draggedSubject || e.target.closest('.card')) return;

            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';

            const targetSection = e.target.closest('.subject-section.draggable-subject');
            if (targetSection && targetSection !== draggedSubject) {
                targetSection.classList.add('drag-over-subject');
            }

            return false;
        }

        function handleSubjectDragLeave(e) {
            const targetSection = e.target.closest('.subject-section.draggable-subject');
            if (targetSection && !targetSection.contains(e.relatedTarget)) {
                targetSection.classList.remove('drag-over-subject');
            }
        }

        function handleSubjectDrop(e) {
            if (!draggedSubject || e.target.closest('.card')) return;

            if (e.stopPropagation) {
                e.stopPropagation();
            }

            const targetSection = e.target.closest('.subject-section.draggable-subject');
            if (!targetSection || targetSection === draggedSubject) {
                return false;
            }

            const targetIdx = parseInt(targetSection.dataset.subjectIndex);

            const draggedSubjectData = subjects[draggedSubjectIdx];
            subjects.splice(draggedSubjectIdx, 1);
            subjects.splice(targetIdx, 0, draggedSubjectData);

            renderSubjects();

            return false;
        }

        renderSubjects();

        // ä¸»é¢˜åˆ‡æ¢ï¼ˆä¸‰æ®µï¼šè·Ÿéšç³»ç»Ÿ/æµ…è‰²/æ·±è‰²ï¼‰ï¼Œå¸¦å¼¹å‡ºèœå•ä¸æŒä¹…åŒ–
        (function () {
            const toggles = Array.from(document.querySelectorAll('.theme-toggle'));
            const popover = document.getElementById('themePopover');
            const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');

            const sun = () => '<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><circle cx="12" cy="12" r="5" fill="currentColor"/><g fill="currentColor"><rect x="11" y="2" width="2" height="3"/><rect x="11" y="19" width="2" height="3"/><rect x="2" y="11" width="3" height="2"/><rect x="19" y="11" width="3" height="2"/><rect x="4.2" y="4.2" width="2" height="2" transform="rotate(-45 5.2 5.2)"/><rect x="17.8" y="17.8" width="2" height="2" transform="rotate(-45 18.8 18.8)"/><rect x="4.2" y="17.8" width="2" height="2" transform="rotate(45 5.2 18.8)"/><rect x="17.8" y="4.2" width="2" height="2" transform="rotate(45 18.8 5.2)"/></g></svg>';
            const moon = () => '<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8z" fill="currentColor"/></svg>';

            function getSavedMode() {
                try { return localStorage.getItem('themeMode') || 'auto'; } catch(e) { return 'auto'; }
            }
            function setSavedMode(mode) {
                try { localStorage.setItem('themeMode', mode); } catch(e) {}
            }
            function resolvedTheme(mode) {
                if (mode === 'light') return 'light';
                if (mode === 'dark') return 'dark';
                return (media && media.matches) ? 'dark' : 'light';
            }
            function apply(mode) {
                const t = resolvedTheme(mode);
                document.documentElement.setAttribute('data-theme', t);
                setSavedMode(mode);
                // æ›´æ–°æŒ‰é’®å›¾æ ‡ä¸æç¤º
                toggles.forEach(btn => {
                    if (btn.id === 'themeToggleMobile') { btn.innerHTML = (t === 'dark') ? moon() : sun(); } else { btn.textContent = 'åˆ‡æ¢ä¸»é¢˜'; }
                    const label = mode === 'auto' ? 'è·Ÿéšç³»ç»Ÿ' : (mode === 'dark' ? 'æ·±è‰²' : 'æµ…è‰²');
                    btn.setAttribute('aria-label', 'åˆ‡æ¢ä¸»é¢˜ï¼ˆ' + label + 'ï¼‰');
                    btn.setAttribute('title', 'åˆ‡æ¢ä¸»é¢˜');
                });
                // æ›´æ–°å¼¹çª—é€‰ä¸­é¡¹
                if (popover) {
                    popover.querySelectorAll('.item').forEach(it => {
                        it.classList.toggle('active', it.getAttribute('data-mode') === mode);
                    });
                }
            }
            function openPopoverNear(btn) {
                if (!popover || !btn) return;
                const r = btn.getBoundingClientRect();
                const gap = 8;
                const top = r.bottom + gap;
                let left = r.right - 180; // right aligned to button
                left = Math.max(12, Math.min(left, window.innerWidth - 192));
                popover.style.top = Math.round(top) + 'px';
                popover.style.left = Math.round(left) + 'px';
                popover.classList.add('active');
                popover.setAttribute('aria-hidden', 'false');
            }
            function closePopover() {
                if (!popover) return;
                popover.classList.remove('active');
                popover.setAttribute('aria-hidden', 'true');
            }

            // Init
            let mode = getSavedMode();
            apply(mode);

            // Toggle clickï¼šå•å‡»ç›´æ¥åˆ‡æ¢ï¼ˆlight â†” darkï¼‰ï¼ŒAlt/å³é”®æ‰“å¼€èœå•é€‰æ‹©ï¼ˆå«è·Ÿéšç³»ç»Ÿï¼‰
            toggles.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (e.altKey) {
                        // Alt+Click æ˜¾ç¤º/éšè—èœå•
                        if (popover && popover.classList.contains('active')) closePopover();
                        else openPopoverNear(btn);
                        return;
                    }
                    // ç›´æ¥åœ¨æµ…/æ·±ä¹‹é—´åˆ‡æ¢ï¼›è‹¥å½“å‰ä¸º autoï¼Œåˆ™åˆ‡åˆ°ä¸å½“å‰è§£æç›¸åçš„é‚£ä¸ªï¼Œç»™ç”¨æˆ·æ˜ç¡®åé¦ˆ
                    const modeNow = getSavedMode();
                    let next;
                    if (modeNow === 'auto') {
                        next = resolvedTheme('auto') === 'dark' ? 'light' : 'dark';
                    } else if (modeNow === 'light') {
                        next = 'dark';
                    } else {
                        next = 'light';
                    }
                    apply(next);
                    closePopover();
                });

                // å³é”®æ‰“å¼€èœå•
                btn.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    if (popover && popover.classList.contains('active')) closePopover();
                    else openPopoverNear(btn);
                });
            });

            // Popover interactions
            if (popover) {
                popover.addEventListener('click', (e) => {
                    const item = e.target.closest('.item');
                    if (!item) return;
                    mode = item.getAttribute('data-mode');
                    apply(mode);
                    closePopover();
                });
            }

            // Outside click / Esc to close
            document.addEventListener('click', (e) => {
                if (!popover) return;
                if (!popover.contains(e.target) && !toggles.some(b => b.contains(e.target))) {
                    closePopover();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closePopover();
            });

            // Follow system when mode is auto
            if (media && media.addEventListener) {
                media.addEventListener('change', () => { if (getSavedMode()==='auto') apply('auto'); });
            } else if (media && media.addListener) {
                media.addListener(() => { if (getSavedMode()==='auto') apply('auto'); });
            }
        })();

// Large Title â†’ Compact on scroll
        function applyCompactHeader() {
            const header = document.querySelector('.header');
            if (!header) return;
            if (window.scrollY > 6) header.classList.add('compact');
            else header.classList.remove('compact');
        }
        window.addEventListener('scroll', applyCompactHeader, { passive: true });
        applyCompactHeader();
        // åˆå§‹åŒ–ä¸çª—å£å˜åŒ–æ—¶åŒæ­¥åº•éƒ¨ç©ºéš™
        window.addEventListener('resize', () => { if (typeof updateProgressSpacer==='function') updateProgressSpacer(); }, { passive: true });
        if (typeof updateProgressSpacer==='function') updateProgressSpacer();

        // è®¾ç½®å½“å‰å¹´ä»½
        document.getElementById('currentYear').textContent = new Date().getFullYear();
    </script>
</body>
</html>
